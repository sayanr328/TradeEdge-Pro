<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeEdge Pro - Binary Trading Journal</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK for Auth -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { font-family: 'Inter', sans-serif; }
        :root { --primary: #6366f1; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; }
        .dark { --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-tertiary: #334155; --text-primary: #f8fafc; --text-secondary: #94a3b8; }
        .light { --bg-primary: #f8fafc; --bg-secondary: #ffffff; --bg-tertiary: #e2e8f0; --text-primary: #0f172a; --text-secondary: #64748b; }
        body { background: var(--bg-primary); color: var(--text-primary); transition: all 0.3s; }
        .card { background: var(--bg-secondary); border: 1px solid var(--bg-tertiary); }
        .input-field { background: var(--bg-tertiary); border: 1px solid var(--bg-tertiary); color: var(--text-primary); }
        .input-field:focus { border-color: var(--primary); outline: none; }
        .nav-item { transition: all 0.2s; }
        .nav-item:hover, .nav-item.active { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
        .stat-card { background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary)); }
        .win-badge { background: linear-gradient(135deg, #10b981, #059669); }
        .loss-badge { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .tie-badge { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .glow { box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-tertiary); }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }
        .streak-fire { animation: fire 0.5s ease-in-out infinite alternate; }
        @keyframes fire { from { transform: scale(1); } to { transform: scale(1.1); } }
        .modal { backdrop-filter: blur(8px); }
        .chart-container { position: relative; width: 100%; }
        .calendar-day { transition: all 0.2s; }
        .calendar-day:hover { transform: scale(1.1); z-index: 10; }
        .login-bg { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%); }
        .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .dropdown-menu { display: none; }
        .dropdown-menu.show { display: block; }
    </style>
</head>
<body class="dark min-h-screen">

    <!-- Login/Signup Page -->
    <div id="authPage" class="login-bg min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full">
            <!-- Logo -->
            <div class="text-center mb-8">
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-chart-line text-white text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">TradeEdge Pro</h1>
                <p class="text-[var(--text-secondary)] mt-2">Professional Binary Trading Journal</p>
            </div>

            <!-- Auth Card -->
            <div class="glass rounded-2xl p-8">
                <!-- Tabs -->
                <div class="flex mb-6">
                    <button onclick="showAuthTab('login')" class="auth-tab flex-1 py-2 text-center font-semibold border-b-2 border-indigo-500 text-indigo-400" data-tab="login">Login</button>
                    <button onclick="showAuthTab('signup')" class="auth-tab flex-1 py-2 text-center font-semibold border-b-2 border-transparent text-[var(--text-secondary)]" data-tab="signup">Sign Up</button>
                </div>

                <!-- Login Form -->
                <form id="loginForm" class="space-y-4" onsubmit="handleLogin(event)">
                    <div>
                        <label class="block text-sm mb-2">Email</label>
                        <input type="email" class="input-field w-full px-4 py-3 rounded-xl" id="loginEmail" placeholder="trader@example.com" required>
                    </div>
                    <div>
                        <label class="block text-sm mb-2">Password</label>
                        <div class="relative">
                            <input type="password" class="input-field w-full px-4 py-3 rounded-xl pr-10" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                            <button type="button" onclick="togglePassword('loginPassword')" class="absolute right-3 top-1/2 -translate-y-1/2 text-[var(--text-secondary)]">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="rounded" id="rememberMe">
                            <span>Remember me</span>
                        </label>
                        <a href="#" class="text-indigo-400 hover:text-indigo-300">Forgot password?</a>
                    </div>
                    <button type="submit" class="w-full py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-600 font-semibold hover:from-indigo-600 hover:to-purple-700 transition-all">
                        Login
                    </button>
                </form>

                <!-- Signup Form -->
                <form id="signupForm" class="space-y-4 hidden" onsubmit="handleSignup(event)">
                    <div>
                        <label class="block text-sm mb-2">Full Name</label>
                        <input type="text" class="input-field w-full px-4 py-3 rounded-xl" id="signupName" placeholder="John Doe" required>
                    </div>
                    <div>
                        <label class="block text-sm mb-2">Email</label>
                        <input type="email" class="input-field w-full px-4 py-3 rounded-xl" id="signupEmail" placeholder="trader@example.com" required>
                    </div>
                    <div>
                        <label class="block text-sm mb-2">Password</label>
                        <div class="relative">
                            <input type="password" class="input-field w-full px-4 py-3 rounded-xl pr-10" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
                            <button type="button" onclick="togglePassword('signupPassword')" class="absolute right-3 top-1/2 -translate-y-1/2 text-[var(--text-secondary)]">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm mb-2">Confirm Password</label>
                        <input type="password" class="input-field w-full px-4 py-3 rounded-xl" id="signupConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <label class="flex items-start gap-2 text-sm cursor-pointer">
                        <input type="checkbox" class="rounded mt-1" required>
                        <span class="text-[var(--text-secondary)]">I agree to the <a href="#" class="text-indigo-400">Terms of Service</a> and <a href="#" class="text-indigo-400">Privacy Policy</a></span>
                    </label>
                    <button type="submit" class="w-full py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-600 font-semibold hover:from-indigo-600 hover:to-purple-700 transition-all">
                        Create Account
                    </button>
                </form>

                <!-- Divider -->
                <div class="flex items-center gap-4 my-6">
                    <div class="flex-1 h-px bg-[var(--bg-tertiary)]"></div>
                    <span class="text-sm text-[var(--text-secondary)]">or continue with</span>
                    <div class="flex-1 h-px bg-[var(--bg-tertiary)]"></div>
                </div>

                <!-- Social Login -->
                <div class="flex gap-3">
                    <button onclick="handleGoogleLogin()" class="flex-1 py-3 rounded-xl border border-[var(--bg-tertiary)] hover:border-indigo-500 transition-all flex items-center justify-center gap-2">
                        <i class="fab fa-google text-red-400"></i>
                        <span class="text-sm">Google</span>
                    </button>
                    <button onclick="handleGithubLogin()" class="flex-1 py-3 rounded-xl border border-[var(--bg-tertiary)] hover:border-indigo-500 transition-all flex items-center justify-center gap-2">
                        <i class="fab fa-github"></i>
                        <span class="text-sm">GitHub</span>
                    </button>
                </div>
            </div>

            <!-- Footer -->
            <p class="text-center text-sm text-[var(--text-secondary)] mt-6">
                Created by <span class="text-indigo-400 font-medium">Sayan Roy</span> ‚Ä¢ TradeEdge Pro v2.0
            </p>
        </div>
    </div>

    <!-- Main App (Hidden until login) -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="fixed top-0 left-0 right-0 z-50 card border-b border-t-0 border-l-0 border-r-0 px-6 py-3">
            <div class="flex items-center justify-between max-w-7xl mx-auto">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                        <i class="fas fa-chart-line text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">TradeEdge Pro</h1>
                        <p class="text-xs text-[var(--text-secondary)]">Binary Trading Journal</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div id="accountSelector" class="flex items-center gap-2 px-3 py-2 rounded-lg card cursor-pointer hover:border-indigo-500">
                        <div class="w-2 h-2 rounded-full bg-green-500"></div>
                        <span class="text-sm font-medium" id="currentAccount">Live Account</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                    <button onclick="toggleTheme()" class="w-10 h-10 rounded-xl card flex items-center justify-center hover:border-indigo-500">
                        <i class="fas fa-moon" id="themeIcon"></i>
                    </button>
                    
                    <!-- Export Dropdown -->
                    <div class="relative">
                        <button onclick="toggleExportDropdown()" class="w-10 h-10 rounded-xl card flex items-center justify-center hover:border-indigo-500">
                            <i class="fas fa-download"></i>
                        </button>
                        <div id="exportDropdown" class="dropdown-menu absolute right-0 top-12 w-72 card rounded-xl p-4 shadow-xl z-50">
                            <h4 class="font-semibold mb-3">Export Data</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs text-[var(--text-secondary)]">Date Range</label>
                                    <div class="flex gap-2 mt-1">
                                        <input type="date" class="input-field px-2 py-1 rounded-lg text-xs flex-1" id="exportStartDate">
                                        <input type="date" class="input-field px-2 py-1 rounded-lg text-xs flex-1" id="exportEndDate">
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="exportData('csv')" class="flex-1 py-2 rounded-lg border border-[var(--bg-tertiary)] hover:border-green-500 text-sm">
                                        <i class="fas fa-file-csv text-green-400 mr-1"></i>CSV
                                    </button>
                                    <button onclick="exportData('json')" class="flex-1 py-2 rounded-lg border border-[var(--bg-tertiary)] hover:border-blue-500 text-sm">
                                        <i class="fas fa-file-code text-blue-400 mr-1"></i>JSON
                                    </button>
                                    <button onclick="exportData('pdf')" class="flex-1 py-2 rounded-lg border border-[var(--bg-tertiary)] hover:border-red-500 text-sm">
                                        <i class="fas fa-file-pdf text-red-400 mr-1"></i>PDF
                                    </button>
                                </div>
                                <button onclick="exportData('all')" class="w-full py-2 rounded-lg bg-indigo-500/20 text-indigo-400 text-sm hover:bg-indigo-500/30">
                                    <i class="fas fa-download mr-1"></i>Export All Data
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Profile -->
                    <div onclick="showSection('profile')" class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center cursor-pointer overflow-hidden">
                        <img id="headerProfilePic" src="" class="w-full h-full object-cover hidden">
                        <span id="headerProfileInitials" class="text-white font-bold text-sm">TP</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Layout -->
        <div class="flex pt-16">
            <!-- Sidebar Navigation -->
            <nav class="fixed left-0 top-16 bottom-0 w-64 card border-t-0 border-b-0 border-l-0 p-4 overflow-y-auto">
                <div class="space-y-2">
                    <button onclick="showSection('dashboard')" class="nav-item active w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left" data-section="dashboard">
                        <i class="fas fa-th-large w-5"></i>
                        <span class="font-medium">Dashboard</span>
                    </button>
                    <button onclick="showSection('newTrade')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left" data-section="newTrade">
                        <i class="fas fa-plus-circle w-5"></i>
                        <span class="font-medium">New Trade</span>
                    </button>
                    <button onclick="showSection('tradeHistory')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left" data-section="tradeHistory">
                        <i class="fas fa-history w-5"></i>
                        <span class="font-medium">Trade History</span>
                    </button>
                    <button onclick="showSection('calendar')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left" data-section="calendar">
                        <i class="fas fa-calendar-alt w-5"></i>
                        <span class="font-medium">Calendar</span>
                    </button>
                    <button onclick="showSection('analytics')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left" data-section="analytics">
                        <i class="fas fa-chart-bar w-5"></i>
                        <span class="font-medium">Analytics</span>
                    </button>
                    <button onclick="showSection('psychology')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left" data-section="psychology">
                        <i class="fas fa-brain w-5"></i>
                        <span class="font-medium">Psychology</span>
                    </button>
                    <button onclick="showSection('growthCalc')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left" data-section="growthCalc">
                        <i class="fas fa-calculator w-5"></i>
                        <span class="font-medium">Growth Calculator</span>
                    </button>
                    <button onclick="showSection('riskEngine')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left" data-section="riskEngine">
                        <i class="fas fa-shield-alt w-5"></i>
                        <span class="font-medium">Risk Engine</span>
                    </button>
                    <button onclick="showSection('reports')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left" data-section="reports">
                        <i class="fas fa-file-alt w-5"></i>
                        <span class="font-medium">Reports</span>
                    </button>
                    <button onclick="showSection('profile')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left" data-section="profile">
                        <i class="fas fa-user w-5"></i>
                        <span class="font-medium">Profile</span>
                    </button>
                    <button onclick="showSection('settings')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left" data-section="settings">
                        <i class="fas fa-cog w-5"></i>
                        <span class="font-medium">Settings</span>
                    </button>
                    <button onclick="showSection('about')" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left" data-section="about">
                        <i class="fas fa-info-circle w-5"></i>
                        <span class="font-medium">About</span>
                    </button>
                </div>
                
                <!-- Daily TP/SL Progress -->
                <div class="mt-6 p-4 rounded-xl card">
                    <h4 class="text-sm font-semibold mb-3">Daily Targets</h4>
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-green-400">Take Profit</span>
                                <span id="sidebarTPProgress">0% / 5%</span>
                            </div>
                            <div class="h-2 bg-[var(--bg-tertiary)] rounded-full overflow-hidden">
                                <div id="sidebarTPBar" class="h-full bg-gradient-to-r from-green-500 to-emerald-400 transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-red-400">Stop Loss</span>
                                <span id="sidebarSLProgress">0% / 3%</span>
                            </div>
                            <div class="h-2 bg-[var(--bg-tertiary)] rounded-full overflow-hidden">
                                <div id="sidebarSLBar" class="h-full bg-gradient-to-r from-red-500 to-orange-400 transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Win Streak -->
                <div class="mt-4 p-4 rounded-xl card">
                    <div class="flex items-center gap-3">
                        <div class="streak-fire text-2xl">üî•</div>
                        <div>
                            <p class="text-xs text-[var(--text-secondary)]">Current Streak</p>
                            <p class="text-xl font-bold" id="currentStreak">0</p>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="ml-64 flex-1 p-6 min-h-screen">
                <!-- Dashboard Section -->
                <section id="dashboard" class="section">
                    <!-- Quick Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                        <!-- Total Balance Card -->
                        <div class="stat-card rounded-2xl p-5 border border-[var(--bg-tertiary)] bg-gradient-to-br from-indigo-500/10 to-purple-500/10 relative">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-[var(--text-secondary)] text-sm">Total Balance</span>
                                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                                    <i class="fas fa-wallet text-white"></i>
                                </div>
                            </div>
                            <div class="flex items-center gap-1">
                                <span class="text-3xl font-bold text-indigo-400">$</span>
                                <input type="text" id="totalBalanceInput" class="text-3xl font-bold text-indigo-400 bg-transparent border-none outline-none w-40 cursor-text hover:bg-[var(--bg-tertiary)] focus:bg-[var(--bg-tertiary)] rounded-lg px-1 transition-all" value="1,000.00" onclick="this.select()" onchange="updateBalanceFromInput(this.value)" onblur="formatBalanceInput()" onkeypress="if(event.key==='Enter'){this.blur();}">
                                <button onclick="document.getElementById('totalBalanceInput').focus(); document.getElementById('totalBalanceInput').select();" class="text-indigo-400 hover:text-indigo-300 opacity-60 hover:opacity-100 transition-opacity" title="Click to edit balance">
                                    <i class="fas fa-pen text-xs"></i>
                                </button>
                            </div>
                            <p class="text-xs mt-2" id="totalPLPercent"><span class="text-green-400"><i class="fas fa-arrow-up mr-1"></i>+0%</span> all time</p>
                        </div>
                        
                        <!-- Daily TP/SL Card -->
                        <div id="tpslCard" class="stat-card rounded-2xl p-5 border border-[var(--bg-tertiary)] transition-all duration-300">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-[var(--text-secondary)] text-sm">Daily TP / SL</span>
                                <div id="tpslIcon" class="w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-red-500 flex items-center justify-center">
                                    <i class="fas fa-bullseye text-white"></i>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-lg font-bold text-green-400" id="dailyTPDisplay">+5%</span>
                                <span class="text-[var(--text-secondary)]">/</span>
                                <span class="text-lg font-bold text-red-400" id="dailySLDisplay">-3%</span>
                            </div>
                            <p class="text-xs mt-1" id="tpslStatus">Set in settings</p>
                            <!-- TP/SL Hit Badge -->
                            <div id="tpslHitBadge" class="hidden mt-2 px-3 py-1 rounded-lg text-xs font-bold text-center animate-pulse"></div>
                        </div>
                        
                        <div class="stat-card rounded-2xl p-5 border border-[var(--bg-tertiary)]">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-[var(--text-secondary)] text-sm">Win Rate</span>
                                <div class="w-10 h-10 rounded-xl bg-green-500/20 flex items-center justify-center">
                                    <i class="fas fa-percentage text-green-400"></i>
                                </div>
                            </div>
                            <p class="text-3xl font-bold" id="winRateStat">0%</p>
                            <p class="text-xs text-[var(--text-secondary)] mt-1" id="winRateChange">No trades yet</p>
                        </div>
                        <div class="stat-card rounded-2xl p-5 border border-[var(--bg-tertiary)]">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-[var(--text-secondary)] text-sm">Today's P/L</span>
                                <div class="w-10 h-10 rounded-xl bg-indigo-500/20 flex items-center justify-center">
                                    <i class="fas fa-dollar-sign text-indigo-400"></i>
                                </div>
                            </div>
                            <p class="text-3xl font-bold" id="todayPL">$0.00</p>
                            <p class="text-xs text-[var(--text-secondary)] mt-1" id="todayTrades">0 trades today</p>
                        </div>
                        <div class="stat-card rounded-2xl p-5 border border-[var(--bg-tertiary)]">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-[var(--text-secondary)] text-sm">Profit Factor</span>
                                <div class="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center">
                                    <i class="fas fa-chart-pie text-purple-400"></i>
                                </div>
                            </div>
                            <p class="text-3xl font-bold" id="profitFactor">0</p>
                            <p class="text-xs text-[var(--text-secondary)] mt-1" id="profitFactorStatus">Add trades to see</p>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        <div class="lg:col-span-2 card rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold">Equity Curve</h3>
                                <div class="flex gap-2">
                                    <button class="px-3 py-1 text-xs rounded-lg bg-indigo-500/20 text-indigo-400">1W</button>
                                    <button class="px-3 py-1 text-xs rounded-lg hover:bg-[var(--bg-tertiary)]">1M</button>
                                    <button class="px-3 py-1 text-xs rounded-lg hover:bg-[var(--bg-tertiary)]">ALL</button>
                                </div>
                            </div>
                            <div class="chart-container" style="height: 200px;">
                                <canvas id="equityChart"></canvas>
                            </div>
                        </div>
                        <div class="card rounded-2xl p-6">
                            <h3 class="text-lg font-semibold mb-4">Session Performance</h3>
                            <div class="chart-container" style="height: 200px;">
                                <canvas id="sessionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Trades -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card rounded-2xl p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold">Recent Trades</h3>
                                <button onclick="showSection('tradeHistory')" class="text-sm text-indigo-400 hover:text-indigo-300">View All</button>
                            </div>
                            <div class="space-y-3" id="recentTradesList"></div>
                        </div>
                        <div class="card rounded-2xl p-6">
                            <div class="flex items-center gap-2 mb-4">
                                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                                    <i class="fas fa-robot text-white text-sm"></i>
                                </div>
                                <h3 class="text-lg font-semibold">AI Insights</h3>
                            </div>
                            <div class="space-y-4" id="aiInsights">
                                <div class="p-4 rounded-xl bg-indigo-500/10 border border-indigo-500/30">
                                    <div class="flex items-start gap-3">
                                        <i class="fas fa-lightbulb text-indigo-400 mt-1"></i>
                                        <div>
                                            <p class="text-sm font-medium text-indigo-400">Getting Started</p>
                                            <p class="text-xs text-[var(--text-secondary)] mt-1">Log trades to receive AI-powered insights.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- New Trade Section -->
                <section id="newTrade" class="section hidden">
                    <div class="max-w-4xl mx-auto">
                        <div class="card rounded-2xl p-8">
                            <h2 class="text-2xl font-bold mb-6">Log New Trade</h2>
                            <form id="tradeForm" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Asset / Pair</label>
                                        <select class="input-field w-full px-4 py-3 rounded-xl" id="asset" required>
                                            <option value="">Select Asset</option>
                                            <option value="EUR/USD">EUR/USD</option>
                                            <option value="GBP/USD">GBP/USD</option>
                                            <option value="USD/JPY">USD/JPY</option>
                                            <option value="AUD/USD">AUD/USD</option>
                                            <option value="GBP/JPY">GBP/JPY</option>
                                            <option value="BTC/USD">BTC/USD</option>
                                            <option value="GOLD">GOLD</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Direction</label>
                                        <div class="flex gap-2">
                                            <button type="button" onclick="selectDirection('CALL')" class="direction-btn flex-1 px-4 py-3 rounded-xl border-2 border-green-500/30 hover:border-green-500 hover:bg-green-500/20 transition-all" data-direction="CALL">
                                                <i class="fas fa-arrow-up mr-2"></i>CALL
                                            </button>
                                            <button type="button" onclick="selectDirection('PUT')" class="direction-btn flex-1 px-4 py-3 rounded-xl border-2 border-red-500/30 hover:border-red-500 hover:bg-red-500/20 transition-all" data-direction="PUT">
                                                <i class="fas fa-arrow-down mr-2"></i>PUT
                                            </button>
                                        </div>
                                        <input type="hidden" id="direction" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Expiry</label>
                                        <select class="input-field w-full px-4 py-3 rounded-xl" id="expiry" required>
                                            <option value="30s">30 Seconds</option>
                                            <option value="1m" selected>1 Minute</option>
                                            <option value="5m">5 Minutes</option>
                                            <option value="15m">15 Minutes</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Stake ($)</label>
                                        <input type="number" class="input-field w-full px-4 py-3 rounded-xl" id="stake" placeholder="10.00" step="0.01" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Payout %</label>
                                        <input type="number" class="input-field w-full px-4 py-3 rounded-xl" id="payout" placeholder="85" value="85" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Result</label>
                                        <select class="input-field w-full px-4 py-3 rounded-xl" id="result" required>
                                            <option value="">Select Result</option>
                                            <option value="WIN">WIN ‚úì</option>
                                            <option value="LOSS">LOSS ‚úó</option>
                                            <option value="TIE">TIE ‚óã</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Session</label>
                                        <select class="input-field w-full px-4 py-3 rounded-xl" id="session">
                                            <option value="Asian">Asian</option>
                                            <option value="London" selected>London</option>
                                            <option value="NewYork">New York</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Strategy</label>
                                        <select class="input-field w-full px-4 py-3 rounded-xl" id="strategy">
                                            <option value="Support/Resistance">Support/Resistance</option>
                                            <option value="Trend Following">Trend Following</option>
                                            <option value="Breakout">Breakout</option>
                                            <option value="Reversal">Reversal</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Setup Quality</label>
                                        <div class="flex gap-1" id="setupQuality">
                                            <button type="button" onclick="setRating('setup', 1)" class="rating-star text-2xl text-gray-500 hover:text-yellow-400">‚òÖ</button>
                                            <button type="button" onclick="setRating('setup', 2)" class="rating-star text-2xl text-gray-500 hover:text-yellow-400">‚òÖ</button>
                                            <button type="button" onclick="setRating('setup', 3)" class="rating-star text-2xl text-gray-500 hover:text-yellow-400">‚òÖ</button>
                                            <button type="button" onclick="setRating('setup', 4)" class="rating-star text-2xl text-gray-500 hover:text-yellow-400">‚òÖ</button>
                                            <button type="button" onclick="setRating('setup', 5)" class="rating-star text-2xl text-gray-500 hover:text-yellow-400">‚òÖ</button>
                                        </div>
                                        <input type="hidden" id="setupRating" value="3">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Confidence</label>
                                        <input type="range" class="w-full" id="confidence" min="1" max="10" value="5">
                                        <div class="flex justify-between text-xs text-[var(--text-secondary)]">
                                            <span>Low</span><span id="confidenceValue">5</span><span>High</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Emotion Before</label>
                                        <div class="flex flex-wrap gap-2" id="emotionBefore">
                                            <button type="button" onclick="selectEmotion('before', 'Calm')" class="emotion-btn px-3 py-2 rounded-lg border border-[var(--bg-tertiary)] text-sm">üòå Calm</button>
                                            <button type="button" onclick="selectEmotion('before', 'Confident')" class="emotion-btn px-3 py-2 rounded-lg border border-[var(--bg-tertiary)] text-sm">üí™ Confident</button>
                                            <button type="button" onclick="selectEmotion('before', 'Anxious')" class="emotion-btn px-3 py-2 rounded-lg border border-[var(--bg-tertiary)] text-sm">üò∞ Anxious</button>
                                            <button type="button" onclick="selectEmotion('before', 'FOMO')" class="emotion-btn px-3 py-2 rounded-lg border border-[var(--bg-tertiary)] text-sm">üò§ FOMO</button>
                                        </div>
                                        <input type="hidden" id="emotionBeforeValue" value="Calm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Emotion After</label>
                                        <div class="flex flex-wrap gap-2" id="emotionAfter">
                                            <button type="button" onclick="selectEmotion('after', 'Satisfied')" class="emotion-btn px-3 py-2 rounded-lg border border-[var(--bg-tertiary)] text-sm">üòä Satisfied</button>
                                            <button type="button" onclick="selectEmotion('after', 'Neutral')" class="emotion-btn px-3 py-2 rounded-lg border border-[var(--bg-tertiary)] text-sm">üòê Neutral</button>
                                            <button type="button" onclick="selectEmotion('after', 'Frustrated')" class="emotion-btn px-3 py-2 rounded-lg border border-[var(--bg-tertiary)] text-sm">üò§ Frustrated</button>
                                        </div>
                                        <input type="hidden" id="emotionAfterValue" value="Neutral">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Notes</label>
                                    <textarea class="input-field w-full px-4 py-3 rounded-xl h-20 resize-none" id="notes" placeholder="Trade notes..."></textarea>
                                </div>
                                <div class="flex justify-end gap-4">
                                    <button type="button" onclick="resetForm()" class="px-6 py-3 rounded-xl border border-[var(--bg-tertiary)] hover:border-red-500">Cancel</button>
                                    <button type="submit" class="px-8 py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-600 font-semibold">
                                        <i class="fas fa-save mr-2"></i>Save Trade
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- Trade History Section -->
                <section id="tradeHistory" class="section hidden">
                    <div class="card rounded-2xl p-6 mb-6">
                        <div class="flex flex-wrap items-center justify-between gap-4">
                            <h2 class="text-2xl font-bold">Trade History</h2>
                            <div class="flex gap-3">
                                <input type="text" class="input-field px-4 py-2 rounded-lg" placeholder="Search..." id="searchTrades">
                                <select class="input-field px-4 py-2 rounded-lg" id="filterResult">
                                    <option value="">All Results</option>
                                    <option value="WIN">Wins</option>
                                    <option value="LOSS">Losses</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card rounded-2xl overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-[var(--bg-tertiary)]">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold">Asset</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold">Dir</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold">Stake</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold">Result</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold">P/L</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tradeHistoryTable" class="divide-y divide-[var(--bg-tertiary)]"></tbody>
                        </table>
                    </div>
                </section>

                <!-- Calendar Section -->
                <section id="calendar" class="section hidden">
                    <div class="card rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold">Trading Calendar</h2>
                            <div class="flex items-center gap-4">
                                <button onclick="changeMonth(-1)" class="w-10 h-10 rounded-lg card flex items-center justify-center hover:border-indigo-500">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <span class="text-lg font-semibold" id="calendarMonth">January 2025</span>
                                <button onclick="changeMonth(1)" class="w-10 h-10 rounded-lg card flex items-center justify-center hover:border-indigo-500">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-7 gap-2 mb-2">
                            <div class="text-center text-sm font-semibold text-[var(--text-secondary)] py-2">Sun</div>
                            <div class="text-center text-sm font-semibold text-[var(--text-secondary)] py-2">Mon</div>
                            <div class="text-center text-sm font-semibold text-[var(--text-secondary)] py-2">Tue</div>
                            <div class="text-center text-sm font-semibold text-[var(--text-secondary)] py-2">Wed</div>
                            <div class="text-center text-sm font-semibold text-[var(--text-secondary)] py-2">Thu</div>
                            <div class="text-center text-sm font-semibold text-[var(--text-secondary)] py-2">Fri</div>
                            <div class="text-center text-sm font-semibold text-[var(--text-secondary)] py-2">Sat</div>
                        </div>
                        <div class="grid grid-cols-7 gap-2" id="calendarGrid"></div>
                        <div class="flex items-center justify-center gap-6 mt-6">
                            <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-green-500"></div><span class="text-sm">Profit</span></div>
                            <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-red-500"></div><span class="text-sm">Loss</span></div>
                            <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-[var(--bg-tertiary)]"></div><span class="text-sm">No Trade</span></div>
                        </div>
                    </div>
                </section>

                <!-- Analytics Section -->
                <section id="analytics" class="section hidden">
                    <h2 class="text-2xl font-bold mb-4">Performance Analytics</h2>
                    <div class="grid grid-cols-3 md:grid-cols-6 gap-3 mb-4">
                        <div class="card rounded-xl p-3 text-center">
                            <p class="text-xs text-[var(--text-secondary)]">Trades</p>
                            <p class="text-xl font-bold" id="analyticsTotalTrades">0</p>
                        </div>
                        <div class="card rounded-xl p-3 text-center">
                            <p class="text-xs text-[var(--text-secondary)]">Win Rate</p>
                            <p class="text-xl font-bold text-green-400" id="analyticsWinRate">0%</p>
                        </div>
                        <div class="card rounded-xl p-3 text-center">
                            <p class="text-xs text-[var(--text-secondary)]">Expectancy</p>
                            <p class="text-xl font-bold" id="analyticsExpectancy">$0</p>
                        </div>
                        <div class="card rounded-xl p-3 text-center">
                            <p class="text-xs text-[var(--text-secondary)]">Profit Factor</p>
                            <p class="text-xl font-bold" id="analyticsProfitFactor">0</p>
                        </div>
                        <div class="card rounded-xl p-3 text-center">
                            <p class="text-xs text-[var(--text-secondary)]">Best Streak</p>
                            <p class="text-xl font-bold text-green-400" id="analyticsBestStreak">0</p>
                        </div>
                        <div class="card rounded-xl p-3 text-center">
                            <p class="text-xs text-[var(--text-secondary)]">Worst Streak</p>
                            <p class="text-xl font-bold text-red-400" id="analyticsWorstStreak">0</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div class="card rounded-xl p-4">
                            <h3 class="text-sm font-semibold mb-2">Win/Loss</h3>
                            <div class="chart-container" style="height: 120px;"><canvas id="winLossChart"></canvas></div>
                        </div>
                        <div class="card rounded-xl p-4">
                            <h3 class="text-sm font-semibold mb-2">By Asset</h3>
                            <div class="chart-container" style="height: 120px;"><canvas id="assetChart"></canvas></div>
                        </div>
                        <div class="card rounded-xl p-4">
                            <h3 class="text-sm font-semibold mb-2">By Hour</h3>
                            <div class="chart-container" style="height: 120px;"><canvas id="hourlyChart"></canvas></div>
                        </div>
                        <div class="card rounded-xl p-4">
                            <h3 class="text-sm font-semibold mb-2">By Expiry</h3>
                            <div class="chart-container" style="height: 120px;"><canvas id="expiryChart"></canvas></div>
                        </div>
                    </div>
                </section>

                <!-- Psychology Section -->
                <section id="psychology" class="section hidden">
                    <h2 class="text-2xl font-bold mb-4">Psychology & Discipline</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                        <div class="card rounded-xl p-4">
                            <h3 class="text-sm font-semibold mb-3">Emotion vs Win Rate</h3>
                            <div class="space-y-2 max-h-48 overflow-y-auto" id="emotionHeatmap"></div>
                        </div>
                        <div class="card rounded-xl p-4">
                            <h3 class="text-sm font-semibold mb-2">Confidence vs Win Rate</h3>
                            <div class="chart-container" style="height: 140px;"><canvas id="confidenceChart"></canvas></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="card rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-8 h-8 rounded-lg bg-red-500/20 flex items-center justify-center">
                                    <i class="fas fa-bolt text-red-400"></i>
                                </div>
                                <div>
                                    <p class="text-xs text-[var(--text-secondary)]">Revenge Trades</p>
                                    <p class="text-xl font-bold" id="revengeTrades">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="card rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-8 h-8 rounded-lg bg-yellow-500/20 flex items-center justify-center">
                                    <i class="fas fa-fire text-yellow-400"></i>
                                </div>
                                <div>
                                    <p class="text-xs text-[var(--text-secondary)]">Overtrading Days</p>
                                    <p class="text-xl font-bold" id="overtradingDays">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="card rounded-xl p-4">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center">
                                    <i class="fas fa-brain text-purple-400"></i>
                                </div>
                                <div>
                                    <p class="text-xs text-[var(--text-secondary)]">Tilt Episodes</p>
                                    <p class="text-xl font-bold" id="tiltEpisodes">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Growth Calculator Section -->
                <section id="growthCalc" class="section hidden">
                    <h2 class="text-2xl font-bold mb-6">Growth Calculator</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card rounded-2xl p-6">
                            <h3 class="text-lg font-semibold mb-4">Calculate Your Growth</h3>
                            <div class="space-y-5">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Starting Capital ($)</label>
                                    <input type="number" class="input-field w-full px-4 py-3 rounded-xl" id="growthStartBalance" value="100" oninput="calculateGrowth()">
                                    <p class="text-xs text-[var(--text-secondary)] mt-1">Your initial trading capital</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Daily Growth (%)</label>
                                    <input type="number" class="input-field w-full px-4 py-3 rounded-xl" id="growthDailyPercent" value="5" step="0.1" oninput="calculateGrowth()">
                                    <p class="text-xs text-[var(--text-secondary)] mt-1">Expected daily profit percentage</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Number of Days</label>
                                    <input type="number" class="input-field w-full px-4 py-3 rounded-xl" id="growthDays" value="30" oninput="calculateGrowth()">
                                    <p class="text-xs text-[var(--text-secondary)] mt-1">Trading days to project</p>
                                </div>
                                <button onclick="calculateGrowth()" class="w-full py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-600 font-semibold">
                                    <i class="fas fa-calculator mr-2"></i>Calculate Growth
                                </button>
                            </div>
                        </div>
                        <div class="card rounded-2xl p-6">
                            <h3 class="text-lg font-semibold mb-4">Projected Results</h3>
                            <div class="space-y-4">
                                <div class="p-5 rounded-xl bg-gradient-to-br from-green-500/20 to-emerald-500/10 border border-green-500/30">
                                    <p class="text-sm text-[var(--text-secondary)]">Final Balance</p>
                                    <p class="text-4xl font-bold text-green-400" id="growthFinalBalance">$0.00</p>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="p-4 rounded-xl bg-indigo-500/10 border border-indigo-500/30">
                                        <p class="text-xs text-[var(--text-secondary)]">Total Profit</p>
                                        <p class="text-2xl font-bold text-indigo-400" id="growthTotalProfit">$0.00</p>
                                    </div>
                                    <div class="p-4 rounded-xl bg-purple-500/10 border border-purple-500/30">
                                        <p class="text-xs text-[var(--text-secondary)]">Growth %</p>
                                        <p class="text-2xl font-bold text-purple-400" id="growthPercentage">0%</p>
                                    </div>
                                </div>
                                <div class="p-4 rounded-xl bg-[var(--bg-tertiary)]">
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="text-sm text-[var(--text-secondary)]">Daily Breakdown</span>
                                        <span class="text-xs text-indigo-400" id="growthDailyAvg">+$0/day</span>
                                    </div>
                                    <div class="grid grid-cols-3 gap-3 text-center">
                                        <div>
                                            <p class="text-xs text-[var(--text-secondary)]">Week 1</p>
                                            <p class="text-sm font-bold text-green-400" id="growthWeek1">$0</p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-[var(--text-secondary)]">Week 2</p>
                                            <p class="text-sm font-bold text-green-400" id="growthWeek2">$0</p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-[var(--text-secondary)]">Week 4</p>
                                            <p class="text-sm font-bold text-green-400" id="growthWeek4">$0</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4">
                                <h4 class="text-sm font-semibold mb-2">Growth Curve (Compound)</h4>
                                <div class="chart-container" style="height: 150px;"><canvas id="growthChart"></canvas></div>
                            </div>
                            
                            <!-- Daily Profit Breakdown Table -->
                            <div class="mt-4">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="text-sm font-semibold">üìÖ Daily Profit Breakdown</h4>
                                    <span class="text-xs text-[var(--text-secondary)]">Scroll to view all</span>
                                </div>
                                <div class="max-h-52 overflow-y-auto rounded-xl border border-[var(--bg-tertiary)]">
                                    <table class="w-full text-sm">
                                        <thead class="bg-[var(--bg-tertiary)] sticky top-0">
                                            <tr>
                                                <th class="px-3 py-2 text-left text-xs font-semibold">Day</th>
                                                <th class="px-3 py-2 text-right text-xs font-semibold">Start</th>
                                                <th class="px-3 py-2 text-right text-xs font-semibold">Profit</th>
                                                <th class="px-3 py-2 text-right text-xs font-semibold">End</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dailyProfitTable" class="divide-y divide-[var(--bg-tertiary)]"></tbody>
                                    </table>
                                </div>
                                <div class="mt-3 p-3 rounded-xl bg-gradient-to-r from-green-500/10 to-emerald-500/10 border border-green-500/30">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm font-medium">üí∞ Total Profit (All Days)</span>
                                        <span class="text-lg font-bold text-green-400" id="growthTotalProfitSum">$0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Risk Engine Section -->
                <section id="riskEngine" class="section hidden">
                    <h2 class="text-2xl font-bold mb-6">Risk Management</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card rounded-2xl p-6">
                            <h3 class="text-lg font-semibold mb-4">Position Size Calculator</h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <label class="block text-xs mb-1">Balance</label>
                                        <input type="number" class="input-field w-full px-3 py-2 rounded-lg text-sm" id="accountBalance" value="1000">
                                    </div>
                                    <div>
                                        <label class="block text-xs mb-1">Risk %</label>
                                        <input type="number" class="input-field w-full px-3 py-2 rounded-lg text-sm" id="riskPercent" value="2">
                                    </div>
                                    <div>
                                        <label class="block text-xs mb-1">Payout %</label>
                                        <input type="number" class="input-field w-full px-3 py-2 rounded-lg text-sm" id="calcPayout" value="85">
                                    </div>
                                </div>
                                <button onclick="calculatePosition()" class="w-full py-2 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-600 font-semibold text-sm">Calculate</button>
                                <div class="p-3 rounded-xl bg-[var(--bg-tertiary)] text-center">
                                    <p class="text-xs text-[var(--text-secondary)]">Recommended Stake</p>
                                    <p class="text-2xl font-bold text-green-400" id="calcResult">$20.00</p>
                                </div>
                            </div>
                        </div>
                        <div class="card rounded-2xl p-6">
                            <h3 class="text-lg font-semibold mb-4">Risk Parameters</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="flex items-center justify-between mb-2">
                                        <span class="text-sm">Max Risk Per Trade</span>
                                        <span class="text-sm font-bold text-indigo-400" id="maxRiskValue">2%</span>
                                    </label>
                                    <input type="range" class="w-full" id="maxRiskSlider" min="0.5" max="5" step="0.5" value="2">
                                </div>
                                <div>
                                    <label class="flex items-center justify-between mb-2">
                                        <span class="text-sm">Max Trades Per Day</span>
                                        <span class="text-sm font-bold" id="maxTradesValue">15</span>
                                    </label>
                                    <input type="range" class="w-full" id="maxTradesSlider" min="5" max="50" value="15">
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Reports Section -->
                <section id="reports" class="section hidden">
                    <h2 class="text-2xl font-bold mb-6">Performance Reports</h2>
                    <div id="reportsEmptyState" class="card rounded-xl p-8 text-center">
                        <i class="fas fa-file-alt text-5xl text-[var(--text-secondary)] mb-4"></i>
                        <h3 class="text-lg font-semibold mb-2">No Reports Yet</h3>
                        <p class="text-sm text-[var(--text-secondary)]">Start logging trades to generate reports.</p>
                    </div>
                    <div id="reportsContent" class="hidden">
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="card rounded-xl p-4">
                                <p class="text-xs text-[var(--text-secondary)]">Consistency</p>
                                <p class="text-xl font-bold text-green-400" id="reportConsistency">0%</p>
                                <div class="h-2 bg-[var(--bg-tertiary)] rounded-full mt-2">
                                    <div class="h-full bg-green-500 rounded-full" id="reportConsistencyBar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="card rounded-xl p-4">
                                <p class="text-xs text-[var(--text-secondary)]">Discipline</p>
                                <p class="text-xl font-bold text-indigo-400" id="reportDiscipline">0%</p>
                                <div class="h-2 bg-[var(--bg-tertiary)] rounded-full mt-2">
                                    <div class="h-full bg-indigo-500 rounded-full" id="reportDisciplineBar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="card rounded-xl p-4">
                                <p class="text-xs text-[var(--text-secondary)]">Behavioral</p>
                                <p class="text-xl font-bold text-purple-400" id="reportBehavioral">0%</p>
                                <div class="h-2 bg-[var(--bg-tertiary)] rounded-full mt-2">
                                    <div class="h-full bg-purple-500 rounded-full" id="reportBehavioralBar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card rounded-xl p-4">
                            <h3 class="text-sm font-semibold mb-3">üèÜ Achievements</h3>
                            <div class="grid grid-cols-3 md:grid-cols-6 gap-3" id="achievementsBadges"></div>
                        </div>
                    </div>
                </section>

                <!-- Profile Section -->
                <section id="profile" class="section hidden">
                    <h2 class="text-2xl font-bold mb-6">Profile Settings</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="card rounded-2xl p-6 text-center">
                            <div class="w-32 h-32 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 mx-auto mb-4 flex items-center justify-center overflow-hidden relative cursor-pointer" onclick="document.getElementById('profilePicInput').click()">
                                <img id="profilePicPreview" src="" class="w-full h-full object-cover hidden">
                                <span id="profileInitials" class="text-4xl font-bold text-white">TP</span>
                                <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
                                    <i class="fas fa-camera text-white text-2xl"></i>
                                </div>
                            </div>
                            <input type="file" id="profilePicInput" class="hidden" accept="image/*" onchange="updateProfilePic(event)">
                            <h3 class="text-xl font-bold" id="profileName">Trader Pro</h3>
                            <p class="text-sm text-[var(--text-secondary)]" id="profileEmail">trader@example.com</p>
                        </div>
                        <div class="lg:col-span-2 card rounded-2xl p-6">
                            <h3 class="text-lg font-semibold mb-4">Update Details</h3>
                            <form id="profileForm" class="space-y-4" onsubmit="updateProfile(event)">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm mb-2">Full Name</label>
                                        <input type="text" class="input-field w-full px-4 py-3 rounded-lg" id="profileNameInput" placeholder="Your name">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-2">Email</label>
                                        <input type="email" class="input-field w-full px-4 py-3 rounded-lg" id="profileEmailInput" placeholder="your@email.com">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm mb-2">Bio</label>
                                    <textarea class="input-field w-full px-4 py-3 rounded-lg h-20 resize-none" id="profileBio" placeholder="Tell us about yourself..."></textarea>
                                </div>
                                <button type="submit" class="px-6 py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-600 font-semibold">
                                    <i class="fas fa-save mr-2"></i>Save Changes
                                </button>
                            </form>
                            <hr class="my-6 border-[var(--bg-tertiary)]">
                            <h3 class="text-lg font-semibold mb-4">Change Password</h3>
                            <form id="passwordForm" class="space-y-4" onsubmit="updatePassword(event)">
                                <div>
                                    <label class="block text-sm mb-2">Current Password</label>
                                    <input type="password" class="input-field w-full px-4 py-3 rounded-lg" id="currentPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm mb-2">New Password</label>
                                        <input type="password" class="input-field w-full px-4 py-3 rounded-lg" id="newPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                    </div>
                                    <div>
                                        <label class="block text-sm mb-2">Confirm Password</label>
                                        <input type="password" class="input-field w-full px-4 py-3 rounded-lg" id="confirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                    </div>
                                </div>
                                <button type="submit" class="px-6 py-3 rounded-xl border border-[var(--bg-tertiary)] hover:border-indigo-500">
                                    <i class="fas fa-key mr-2"></i>Update Password
                                </button>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- Settings Section -->
                <section id="settings" class="section hidden">
                    <h2 class="text-2xl font-bold mb-6">Settings</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card rounded-2xl p-6">
                            <h3 class="text-lg font-semibold mb-4">Account Settings</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm mb-2">Starting Balance ($)</label>
                                    <input type="number" class="input-field w-full px-4 py-3 rounded-lg" id="startingBalanceInput" value="1000" onchange="saveStartingBalance(this.value)">
                                </div>
                                <div>
                                    <label class="block text-sm mb-2">Daily Take Profit (%)</label>
                                    <input type="number" class="input-field w-full px-4 py-3 rounded-lg" id="dailyTPInput" value="5" onchange="saveTPSL()">
                                </div>
                                <div>
                                    <label class="block text-sm mb-2">Daily Stop Loss (%)</label>
                                    <input type="number" class="input-field w-full px-4 py-3 rounded-lg" id="dailySLInput" value="3" onchange="saveTPSL()">
                                </div>
                                <div>
                                    <label class="block text-sm mb-2">Broker</label>
                                    <select class="input-field w-full px-4 py-3 rounded-lg" id="brokerSelect">
                                        <option>Quotex</option>
                                        <option>Pocket Option</option>
                                        <option>IQ Option</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="card rounded-2xl p-6">
                            <h3 class="text-lg font-semibold mb-4">Data Management</h3>
                            <div class="space-y-3">
                                <button onclick="exportData('csv')" class="w-full py-3 rounded-xl border border-[var(--bg-tertiary)] hover:border-green-500">
                                    <i class="fas fa-file-csv text-green-400 mr-2"></i>Export as CSV
                                </button>
                                <button onclick="exportData('json')" class="w-full py-3 rounded-xl border border-[var(--bg-tertiary)] hover:border-blue-500">
                                    <i class="fas fa-file-code text-blue-400 mr-2"></i>Export as JSON
                                </button>
                                <button onclick="exportData('pdf')" class="w-full py-3 rounded-xl border border-[var(--bg-tertiary)] hover:border-red-500">
                                    <i class="fas fa-file-pdf text-red-400 mr-2"></i>Export as PDF
                                </button>
                                <div class="relative">
                                    <input type="file" id="importFile" accept=".csv,.json" class="hidden" onchange="importData(event)">
                                    <button onclick="document.getElementById('importFile').click()" class="w-full py-3 rounded-xl border border-[var(--bg-tertiary)] hover:border-indigo-500">
                                        <i class="fas fa-file-import text-indigo-400 mr-2"></i>Import Data
                                    </button>
                                </div>
                                <button onclick="clearAllData()" class="w-full py-3 rounded-xl border border-red-500/50 text-red-400 hover:bg-red-500/20">
                                    <i class="fas fa-trash-alt mr-2"></i>Clear All Data
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- About Section -->
                <section id="about" class="section hidden">
                    <div class="max-w-2xl mx-auto">
                        <div class="card rounded-2xl p-8 text-center">
                            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 mx-auto mb-6 flex items-center justify-center">
                                <i class="fas fa-chart-line text-white text-3xl"></i>
                            </div>
                            <h1 class="text-3xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent mb-2">TradeEdge Pro</h1>
                            <p class="text-[var(--text-secondary)] mb-8">Professional Binary Trading Journal</p>
                            
                            <div class="card rounded-xl p-6 mb-6 text-left">
                                <h3 class="text-lg font-semibold mb-4 text-center">üë®‚Äçüíª Creator & Developer</h3>
                                <div class="flex items-center gap-4 mb-4">
                                    <div class="w-16 h-16 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                                        <span class="text-2xl font-bold text-white">SR</span>
                                    </div>
                                    <div>
                                        <h4 class="text-xl font-bold">Sayan Roy</h4>
                                        <p class="text-indigo-400">Binary & Forex Trader ‚Ä¢ AI/ML Engineer</p>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex items-center gap-3 p-3 rounded-lg bg-[var(--bg-tertiary)]">
                                        <i class="fas fa-chart-line text-green-400 w-5"></i>
                                        <span>2+ Years of Trading Experience in Binary & Forex</span>
                                    </div>
                                    <div class="flex items-center gap-3 p-3 rounded-lg bg-[var(--bg-tertiary)]">
                                        <i class="fas fa-robot text-indigo-400 w-5"></i>
                                        <span>AI/ML Engineer - Building Intelligent Trading Tools</span>
                                    </div>
                                    <div class="flex items-center gap-3 p-3 rounded-lg bg-[var(--bg-tertiary)]">
                                        <i class="fas fa-code text-purple-400 w-5"></i>
                                        <span>Full-Stack Developer & Fintech Enthusiast</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-center gap-4 mb-6">
                                <a href="#" class="w-10 h-10 rounded-lg bg-[var(--bg-tertiary)] flex items-center justify-center hover:bg-indigo-500/20"><i class="fab fa-github"></i></a>
                                <a href="#" class="w-10 h-10 rounded-lg bg-[var(--bg-tertiary)] flex items-center justify-center hover:bg-indigo-500/20"><i class="fab fa-linkedin"></i></a>
                                <a href="#" class="w-10 h-10 rounded-lg bg-[var(--bg-tertiary)] flex items-center justify-center hover:bg-indigo-500/20"><i class="fab fa-twitter"></i></a>
                            </div>
                            
                            <p class="text-sm text-[var(--text-secondary)]">Version 2.0 ‚Ä¢ Made with ‚ù§Ô∏è for Traders</p>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 z-50 hidden">
        <div class="px-6 py-4 rounded-xl shadow-xl flex items-center gap-3 card" id="toastContent">
            <i class="fas fa-check-circle text-green-400"></i>
            <span id="toastMessage">Success!</span>
        </div>
    </div>

    <script>
        // ==================== DATA ====================
        let trades = JSON.parse(localStorage.getItem('trades') || '[]');
        let currentTheme = localStorage.getItem('theme') || 'dark';
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
        let calendarDate = new Date();
        let equityChart, sessionChart, winLossChart, assetChart, hourlyChart, expiryChart, confidenceChart, growthChart;

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(currentTheme);
            if (currentUser) {
                showMainApp();
            }
            loadSettings();
        });

        // ==================== AUTH ====================
        function showAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => {
                t.classList.remove('border-indigo-500', 'text-indigo-400');
                t.classList.add('border-transparent', 'text-[var(--text-secondary)]');
            });
            document.querySelector(`[data-tab="${tab}"]`).classList.add('border-indigo-500', 'text-indigo-400');
            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('signupForm').classList.toggle('hidden', tab !== 'signup');
        }

        function togglePassword(id) {
            const input = document.getElementById(id);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.email === email);
            if (user || email) {
                currentUser = user || { name: email.split('@')[0], email };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainApp();
                showToast('Welcome back!');
            }
        }

        function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            if (document.getElementById('signupConfirm').value !== password) {
                showToast('Passwords do not match', 'error');
                return;
            }
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            users.push({ name, email, password });
            localStorage.setItem('users', JSON.stringify(users));
            currentUser = { name, email };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showMainApp();
            showToast('Account created!');
        }

        function showMainApp() {
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            loadUserProfile();
            initializeCharts();
            updateDashboard();
            populateRecentTrades();
            populateTradeHistory();
            updateTPSLDisplay();
            initEventListeners();
        }

        // logout function moved to Firebase section above

        function loadUserProfile() {
            if (!currentUser) return;
            const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0,2);
            document.getElementById('headerProfileInitials').textContent = initials;
            document.getElementById('profileInitials').textContent = initials;
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileNameInput').value = currentUser.name;
            document.getElementById('profileEmailInput').value = currentUser.email;
            
            // Show provider badge if social login
            if (currentUser.provider) {
                const providerIcon = currentUser.provider === 'google' ? 'fab fa-google text-red-400' : 'fab fa-github';
                document.getElementById('profileEmail').innerHTML = currentUser.email + ' <i class="' + providerIcon + ' ml-1"></i>';
            }
            
            if (currentUser.pic) {
                document.getElementById('profilePicPreview').src = currentUser.pic;
                document.getElementById('profilePicPreview').classList.remove('hidden');
                document.getElementById('profileInitials').classList.add('hidden');
                document.getElementById('headerProfilePic').src = currentUser.pic;
                document.getElementById('headerProfilePic').classList.remove('hidden');
                document.getElementById('headerProfileInitials').classList.add('hidden');
            } else {
                document.getElementById('profilePicPreview').classList.add('hidden');
                document.getElementById('profileInitials').classList.remove('hidden');
                document.getElementById('headerProfilePic').classList.add('hidden');
                document.getElementById('headerProfileInitials').classList.remove('hidden');
            }
        }

        function updateProfilePic(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentUser.pic = e.target.result;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    loadUserProfile();
                    showToast('Profile picture updated!');
                };
                reader.readAsDataURL(file);
            }
        }

        function updateProfile(e) {
            e.preventDefault();
            currentUser.name = document.getElementById('profileNameInput').value;
            currentUser.email = document.getElementById('profileEmailInput').value;
            currentUser.bio = document.getElementById('profileBio').value;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            loadUserProfile();
            showToast('Profile updated!');
        }

        function updatePassword(e) {
            e.preventDefault();
            if (document.getElementById('newPassword').value !== document.getElementById('confirmPassword').value) {
                showToast('Passwords do not match', 'error');
                return;
            }
            showToast('Password updated!');
            document.getElementById('passwordForm').reset();
        }

        // ==================== THEME ====================
        function toggleTheme() {
            currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(currentTheme);
            localStorage.setItem('theme', currentTheme);
        }

        function applyTheme(theme) {
            document.body.classList.remove('dark', 'light');
            document.body.classList.add(theme);
            document.getElementById('themeIcon').className = theme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
        }

        // ==================== NAVIGATION ====================
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id)?.classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector(`[data-section="${id}"]`)?.classList.add('active');
            if (id === 'analytics') setTimeout(updateAnalytics, 50);
            if (id === 'psychology') setTimeout(updatePsychology, 50);
            if (id === 'calendar') renderCalendar();
            if (id === 'reports') updateReports();
            if (id === 'growthCalc') calculateGrowth();
        }

        // ==================== EXPORT DROPDOWN ====================
        function toggleExportDropdown() {
            document.getElementById('exportDropdown').classList.toggle('show');
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) {
                document.getElementById('exportDropdown')?.classList.remove('show');
            }
        });

        // ==================== CHARTS ====================
        function initializeCharts() {
            const gridColor = currentTheme === 'dark' ? 'rgba(148,163,184,0.1)' : 'rgba(15,23,42,0.1)';
            const textColor = currentTheme === 'dark' ? '#94a3b8' : '#64748b';

            equityChart = new Chart(document.getElementById('equityChart'), {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.4, pointRadius: 0, borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: gridColor }, ticks: { color: textColor, callback: v => '$' + v } } } }
            });

            sessionChart = new Chart(document.getElementById('sessionChart'), {
                type: 'doughnut',
                data: { labels: ['Asian', 'London', 'NY'], datasets: [{ data: [0, 0, 0], backgroundColor: ['#f59e0b', '#6366f1', '#10b981'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, animation: false, cutout: '60%', plugins: { legend: { position: 'bottom', labels: { color: textColor, padding: 8, font: { size: 10 } } } } }
            });

            updateEquityChart();
        }

        function updateEquityChart() {
            if (!equityChart) return;
            const startingBalance = parseFloat(localStorage.getItem('startingBalance')) || 1000;
            let equity = startingBalance;
            const labels = ['0'];
            const data = [startingBalance];
            [...trades].reverse().forEach((t, i) => {
                equity += t.pl;
                labels.push(String(i + 1));
                data.push(parseFloat(equity.toFixed(2)));
            });
            const isProfit = data[data.length - 1] >= startingBalance;
            equityChart.data.labels = labels;
            equityChart.data.datasets[0].data = data;
            equityChart.data.datasets[0].borderColor = isProfit ? '#10b981' : '#ef4444';
            equityChart.data.datasets[0].backgroundColor = isProfit ? 'rgba(16,185,129,0.1)' : 'rgba(239,68,68,0.1)';
            equityChart.update('none');
        }

        // ==================== DASHBOARD ====================
        function updateDashboard() {
            const startingBalance = parseFloat(localStorage.getItem('startingBalance')) || 1000;
            const totalPL = trades.reduce((s, t) => s + t.pl, 0);
            const currentBalance = startingBalance + totalPL;
            const plPercent = ((totalPL / startingBalance) * 100).toFixed(1);

            document.getElementById('totalBalanceInput').value = currentBalance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('totalPLPercent').innerHTML = trades.length ? `<span class="${totalPL >= 0 ? 'text-green-400' : 'text-red-400'}"><i class="fas fa-arrow-${totalPL >= 0 ? 'up' : 'down'} mr-1"></i>${totalPL >= 0 ? '+' : ''}${plPercent}%</span> all time` : '<span class="text-[var(--text-secondary)]">Start trading</span>';

            const wins = trades.filter(t => t.result === 'WIN').length;
            const winRate = trades.length ? ((wins / trades.length) * 100).toFixed(1) : 0;
            document.getElementById('winRateStat').textContent = winRate + '%';
            document.getElementById('winRateChange').textContent = trades.length ? `${wins}W / ${trades.length - wins}L` : 'No trades';

            const todayTrades = trades.filter(t => new Date(t.timestamp).toDateString() === new Date().toDateString());
            const todayPL = todayTrades.reduce((s, t) => s + t.pl, 0);
            document.getElementById('todayPL').textContent = (todayPL >= 0 ? '+' : '') + '$' + todayPL.toFixed(2);
            document.getElementById('todayPL').className = `text-3xl font-bold ${todayPL >= 0 ? 'text-green-400' : 'text-red-400'}`;
            document.getElementById('todayTrades').textContent = `${todayTrades.length} trades today`;

            const totalWins = trades.filter(t => t.pl > 0).reduce((s, t) => s + t.pl, 0);
            const totalLosses = Math.abs(trades.filter(t => t.pl < 0).reduce((s, t) => s + t.pl, 0));
            document.getElementById('profitFactor').textContent = totalLosses ? (totalWins / totalLosses).toFixed(2) : '‚àû';

            let streak = 0, lastResult = null;
            for (const t of trades) {
                if (t.result === lastResult || !lastResult) { streak++; lastResult = t.result; }
                else break;
            }
            document.getElementById('currentStreak').textContent = trades.length ? streak + (lastResult === 'WIN' ? ' W' : ' L') : '0';

            updateTPSLBars(todayPL, startingBalance);
            updateSessionChart();
        }

        function updateBalanceFromInput(value) {
            const num = parseFloat(value.replace(/[^0-9.-]/g, ''));
            if (!isNaN(num) && num >= 0) {
                const totalPL = trades.reduce((s, t) => s + t.pl, 0);
                localStorage.setItem('startingBalance', (num - totalPL).toString());
                updateDashboard();
                updateEquityChart();
                showToast('Balance updated!');
            }
        }

        function formatBalanceInput() {
            const input = document.getElementById('totalBalanceInput');
            const num = parseFloat(input.value.replace(/[^0-9.-]/g, ''));
            if (!isNaN(num)) input.value = num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function updateSessionChart() {
            if (!sessionChart) return;
            const sessions = { Asian: 0, London: 0, NewYork: 0 };
            trades.forEach(t => { if (sessions[t.session] !== undefined) sessions[t.session]++; });
            sessionChart.data.datasets[0].data = Object.values(sessions);
            sessionChart.update('none');
        }

        // ==================== TP/SL ====================
        function saveTPSL() {
            localStorage.setItem('dailyTP', document.getElementById('dailyTPInput').value);
            localStorage.setItem('dailySL', document.getElementById('dailySLInput').value);
            updateTPSLDisplay();
            updateDashboard(); // This will update sidebar too
            showToast('TP/SL saved!');
        }

        function updateTPSLDisplay() {
            const tp = localStorage.getItem('dailyTP') || 5;
            const sl = localStorage.getItem('dailySL') || 3;
            document.getElementById('dailyTPDisplay').textContent = '+' + tp + '%';
            document.getElementById('dailySLDisplay').textContent = '-' + sl + '%';
            document.getElementById('dailyTPInput').value = tp;
            document.getElementById('dailySLInput').value = sl;
            
            // Update sidebar with new target values
            const sidebarTPProgress = document.getElementById('sidebarTPProgress');
            const sidebarSLProgress = document.getElementById('sidebarSLProgress');
            if (sidebarTPProgress) {
                const currentTP = sidebarTPProgress.textContent.split('/')[0].trim();
                sidebarTPProgress.textContent = currentTP + ' / ' + tp + '%';
            }
            if (sidebarSLProgress) {
                const currentSL = sidebarSLProgress.textContent.split('/')[0].trim();
                sidebarSLProgress.textContent = currentSL + ' / ' + sl + '%';
            }
        }

        function updateTPSLBars(todayPL, balance) {
            const tp = parseFloat(localStorage.getItem('dailyTP') || 5);
            const sl = parseFloat(localStorage.getItem('dailySL') || 3);
            const plPercent = (todayPL / balance) * 100;
            
            const tpslCard = document.getElementById('tpslCard');
            const tpslIcon = document.getElementById('tpslIcon');
            const tpslStatus = document.getElementById('tpslStatus');
            const tpslHitBadge = document.getElementById('tpslHitBadge');
            
            // Update sidebar Daily Targets
            const sidebarTPProgress = document.getElementById('sidebarTPProgress');
            const sidebarSLProgress = document.getElementById('sidebarSLProgress');
            const sidebarTPBar = document.getElementById('sidebarTPBar');
            const sidebarSLBar = document.getElementById('sidebarSLBar');
            
            // Reset styles
            tpslCard.classList.remove('border-green-500', 'border-red-500', 'shadow-lg', 'shadow-green-500/30', 'shadow-red-500/30');
            tpslHitBadge.classList.add('hidden');
            
            if (todayPL >= 0) {
                const tpProgress = Math.min(100, (plPercent / tp) * 100);
                document.getElementById('tpBar').style.width = tpProgress + '%';
                document.getElementById('tpProgress').textContent = plPercent.toFixed(1) + '% / ' + tp + '%';
                document.getElementById('slBar').style.width = '0%';
                document.getElementById('slProgress').textContent = '0% / ' + sl + '%';
                
                // Update sidebar
                if (sidebarTPProgress) sidebarTPProgress.textContent = plPercent.toFixed(1) + '% / ' + tp + '%';
                if (sidebarSLProgress) sidebarSLProgress.textContent = '0% / ' + sl + '%';
                if (sidebarTPBar) sidebarTPBar.style.width = tpProgress + '%';
                if (sidebarSLBar) sidebarSLBar.style.width = '0%';
                
                // Check if TP is hit
                if (plPercent >= tp) {
                    tpslCard.classList.add('border-green-500', 'shadow-lg', 'shadow-green-500/30');
                    tpslIcon.innerHTML = '<i class="fas fa-trophy text-white"></i>';
                    tpslIcon.className = 'w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-emerald-400 flex items-center justify-center';
                    tpslStatus.textContent = 'üéØ Target achieved!';
                    tpslStatus.className = 'text-xs mt-1 text-green-400 font-semibold';
                    tpslHitBadge.textContent = '‚úÖ TP HIT! +' + plPercent.toFixed(1) + '%';
                    tpslHitBadge.className = 'mt-2 px-3 py-2 rounded-lg text-sm font-bold text-center bg-green-500/20 text-green-400 border border-green-500/50 animate-pulse';
                    tpslHitBadge.classList.remove('hidden');
                } else {
                    tpslIcon.innerHTML = '<i class="fas fa-bullseye text-white"></i>';
                    tpslIcon.className = 'w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-red-500 flex items-center justify-center';
                    tpslStatus.textContent = 'On track for TP (' + (tp - plPercent).toFixed(1) + '% to go)';
                    tpslStatus.className = 'text-xs mt-1 text-green-400';
                }
            } else {
                const slProgress = Math.min(100, (Math.abs(plPercent) / sl) * 100);
                document.getElementById('slBar').style.width = slProgress + '%';
                document.getElementById('slProgress').textContent = Math.abs(plPercent).toFixed(1) + '% / ' + sl + '%';
                document.getElementById('tpBar').style.width = '0%';
                document.getElementById('tpProgress').textContent = '0% / ' + tp + '%';
                
                // Update sidebar
                if (sidebarTPProgress) sidebarTPProgress.textContent = '0% / ' + tp + '%';
                if (sidebarSLProgress) sidebarSLProgress.textContent = Math.abs(plPercent).toFixed(1) + '% / ' + sl + '%';
                if (sidebarTPBar) sidebarTPBar.style.width = '0%';
                if (sidebarSLBar) sidebarSLBar.style.width = slProgress + '%';
                
                // Check if SL is hit
                if (Math.abs(plPercent) >= sl) {
                    tpslCard.classList.add('border-red-500', 'shadow-lg', 'shadow-red-500/30');
                    tpslIcon.innerHTML = '<i class="fas fa-exclamation-triangle text-white"></i>';
                    tpslIcon.className = 'w-10 h-10 rounded-xl bg-gradient-to-br from-red-500 to-orange-500 flex items-center justify-center';
                    tpslStatus.textContent = '‚õî Stop trading today!';
                    tpslStatus.className = 'text-xs mt-1 text-red-400 font-semibold';
                    tpslHitBadge.textContent = 'üõë SL HIT! ' + plPercent.toFixed(1) + '%';
                    tpslHitBadge.className = 'mt-2 px-3 py-2 rounded-lg text-sm font-bold text-center bg-red-500/20 text-red-400 border border-red-500/50 animate-pulse';
                    tpslHitBadge.classList.remove('hidden');
                } else {
                    tpslIcon.innerHTML = '<i class="fas fa-bullseye text-white"></i>';
                    tpslIcon.className = 'w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-red-500 flex items-center justify-center';
                    tpslStatus.textContent = 'Approaching SL (' + (sl - Math.abs(plPercent)).toFixed(1) + '% left)';
                    tpslStatus.className = 'text-xs mt-1 text-yellow-400';
                }
            }
        }

        // ==================== TRADE FORM ====================
        function selectDirection(dir) {
            document.querySelectorAll('.direction-btn').forEach(b => b.classList.remove('border-green-500', 'bg-green-500/20', 'border-red-500', 'bg-red-500/20'));
            const btn = document.querySelector(`[data-direction="${dir}"]`);
            btn.classList.add(dir === 'CALL' ? 'border-green-500' : 'border-red-500', dir === 'CALL' ? 'bg-green-500/20' : 'bg-red-500/20');
            document.getElementById('direction').value = dir;
        }

        function setRating(type, val) {
            document.getElementById(`${type}Rating`).value = val;
            document.querySelectorAll(`#${type}Quality .rating-star`).forEach((s, i) => {
                s.classList.toggle('text-yellow-400', i < val);
                s.classList.toggle('text-gray-500', i >= val);
            });
        }

        function selectEmotion(type, emotion) {
            const container = document.getElementById(`emotion${type.charAt(0).toUpperCase() + type.slice(1)}`);
            container.querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('border-indigo-500', 'bg-indigo-500/20'));
            event.target.classList.add('border-indigo-500', 'bg-indigo-500/20');
            document.getElementById(`emotion${type.charAt(0).toUpperCase() + type.slice(1)}Value`).value = emotion;
        }

        document.getElementById('confidence')?.addEventListener('input', e => document.getElementById('confidenceValue').textContent = e.target.value);

        document.getElementById('tradeForm')?.addEventListener('submit', e => { e.preventDefault(); saveTrade(); });

        function saveTrade() {
            const stake = parseFloat(document.getElementById('stake').value);
            const payout = parseFloat(document.getElementById('payout').value);
            const result = document.getElementById('result').value;
            let pl = result === 'WIN' ? stake * (payout / 100) : result === 'LOSS' ? -stake : 0;

            trades.unshift({
                id: Date.now(),
                asset: document.getElementById('asset').value,
                direction: document.getElementById('direction').value,
                expiry: document.getElementById('expiry').value,
                stake, payout, result, pl,
                session: document.getElementById('session').value,
                strategy: document.getElementById('strategy').value,
                setupRating: parseInt(document.getElementById('setupRating').value),
                confidence: parseInt(document.getElementById('confidence').value),
                emotionBefore: document.getElementById('emotionBeforeValue').value,
                emotionAfter: document.getElementById('emotionAfterValue').value,
                notes: document.getElementById('notes').value,
                timestamp: new Date().toISOString()
            });
            saveTrades();
            updateDashboard();
            populateRecentTrades();
            populateTradeHistory();
            updateEquityChart();
            resetForm();
            showToast('Trade saved!');
        }

        function resetForm() {
            document.getElementById('tradeForm').reset();
            document.querySelectorAll('.direction-btn').forEach(b => b.classList.remove('border-green-500', 'bg-green-500/20', 'border-red-500', 'bg-red-500/20'));
            setRating('setup', 3);
        }

        // ==================== TRADE HISTORY ====================
        function populateRecentTrades() {
            const container = document.getElementById('recentTradesList');
            if (!trades.length) {
                container.innerHTML = '<div class="text-center py-8"><i class="fas fa-inbox text-4xl text-[var(--text-secondary)] mb-3"></i><p class="text-[var(--text-secondary)]">No trades yet</p></div>';
                return;
            }
            container.innerHTML = trades.slice(0, 5).map(t => `
                <div class="flex items-center justify-between p-3 rounded-xl bg-[var(--bg-tertiary)]">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg ${t.result === 'WIN' ? 'bg-green-500/20' : 'bg-red-500/20'} flex items-center justify-center">
                            <i class="fas fa-arrow-${t.direction === 'CALL' ? 'up text-green-400' : 'down text-red-400'} text-sm"></i>
                        </div>
                        <div>
                            <p class="font-medium text-sm">${t.asset}</p>
                            <p class="text-xs text-[var(--text-secondary)]">${new Date(t.timestamp).toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="px-2 py-1 rounded text-xs font-bold ${t.result === 'WIN' ? 'win-badge' : 'loss-badge'}">${t.result}</span>
                        <p class="text-sm font-medium ${t.pl >= 0 ? 'text-green-400' : 'text-red-400'}">${t.pl >= 0 ? '+' : ''}$${t.pl.toFixed(2)}</p>
                    </div>
                </div>
            `).join('');
        }

        function populateTradeHistory() {
            const container = document.getElementById('tradeHistoryTable');
            if (!trades.length) {
                container.innerHTML = '<tr><td colspan="7" class="px-4 py-12 text-center text-[var(--text-secondary)]">No trades yet</td></tr>';
                return;
            }
            container.innerHTML = trades.map(t => `
                <tr class="hover:bg-[var(--bg-tertiary)]/50">
                    <td class="px-4 py-3 text-xs">${new Date(t.timestamp).toLocaleDateString()}</td>
                    <td class="px-4 py-3 text-xs font-medium">${t.asset}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs ${t.direction === 'CALL' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">${t.direction}</span></td>
                    <td class="px-4 py-3 text-xs">$${t.stake.toFixed(2)}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs font-bold ${t.result === 'WIN' ? 'win-badge' : 'loss-badge'}">${t.result}</span></td>
                    <td class="px-4 py-3 text-xs font-medium ${t.pl >= 0 ? 'text-green-400' : 'text-red-400'}">${t.pl >= 0 ? '+' : ''}$${t.pl.toFixed(2)}</td>
                    <td class="px-4 py-3"><button onclick="deleteTrade(${t.id})" class="text-red-400 hover:text-red-300"><i class="fas fa-trash text-xs"></i></button></td>
                </tr>
            `).join('');
        }

        function deleteTrade(id) {
            if (confirm('Delete trade?')) {
                trades = trades.filter(t => t.id !== id);
                saveTrades();
                updateDashboard();
                populateRecentTrades();
                populateTradeHistory();
                updateEquityChart();
                showToast('Trade deleted');
            }
        }

        // ==================== CALENDAR ====================
        function renderCalendar() {
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            document.getElementById('calendarMonth').textContent = calendarDate.toLocaleString('default', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            const dailyPL = {};
            trades.forEach(t => {
                const d = new Date(t.timestamp);
                if (d.getMonth() === month && d.getFullYear() === year) {
                    const key = d.getDate();
                    dailyPL[key] = (dailyPL[key] || 0) + t.pl;
                }
            });

            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += '<div class="h-16 rounded-lg"></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const pl = dailyPL[day];
                const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();
                let bgClass = 'bg-[var(--bg-tertiary)]';
                let textClass = '';
                if (pl !== undefined) {
                    bgClass = pl >= 0 ? 'bg-green-500/30 border border-green-500/50' : 'bg-red-500/30 border border-red-500/50';
                    textClass = pl >= 0 ? 'text-green-400' : 'text-red-400';
                }
                grid.innerHTML += `
                    <div class="calendar-day h-16 rounded-lg ${bgClass} ${isToday ? 'ring-2 ring-indigo-500' : ''} p-2 cursor-pointer">
                        <div class="text-xs font-medium ${isToday ? 'text-indigo-400' : ''}">${day}</div>
                        ${pl !== undefined ? `<div class="text-xs font-bold ${textClass}">${pl >= 0 ? '+' : ''}$${pl.toFixed(0)}</div>` : ''}
                    </div>
                `;
            }
        }

        function changeMonth(dir) {
            calendarDate.setMonth(calendarDate.getMonth() + dir);
            renderCalendar();
        }

        // ==================== ANALYTICS ====================
        function updateAnalytics() {
            const wins = trades.filter(t => t.result === 'WIN');
            const losses = trades.filter(t => t.result === 'LOSS');
            document.getElementById('analyticsTotalTrades').textContent = trades.length;
            document.getElementById('analyticsWinRate').textContent = trades.length ? ((wins.length / trades.length) * 100).toFixed(1) + '%' : '0%';

            const avgWin = wins.length ? wins.reduce((s, t) => s + t.pl, 0) / wins.length : 0;
            const avgLoss = losses.length ? Math.abs(losses.reduce((s, t) => s + t.pl, 0) / losses.length) : 0;
            const wr = wins.length / (trades.length || 1);
            document.getElementById('analyticsExpectancy').textContent = '$' + ((wr * avgWin) - ((1 - wr) * avgLoss)).toFixed(2);

            const totalW = wins.reduce((s, t) => s + t.pl, 0);
            const totalL = Math.abs(losses.reduce((s, t) => s + t.pl, 0));
            document.getElementById('analyticsProfitFactor').textContent = totalL ? (totalW / totalL).toFixed(2) : '‚àû';

            let bw = 0, wl = 0, cs = 0, lr = null;
            trades.forEach(t => {
                if (t.result === lr) cs++;
                else { if (lr === 'WIN') bw = Math.max(bw, cs); if (lr === 'LOSS') wl = Math.max(wl, cs); cs = 1; lr = t.result; }
            });
            if (lr === 'WIN') bw = Math.max(bw, cs); if (lr === 'LOSS') wl = Math.max(wl, cs);
            document.getElementById('analyticsBestStreak').textContent = bw;
            document.getElementById('analyticsWorstStreak').textContent = wl;

            updateAnalyticsCharts();
        }

        function updateAnalyticsCharts() {
            const textColor = currentTheme === 'dark' ? '#94a3b8' : '#64748b';
            const gridColor = currentTheme === 'dark' ? 'rgba(148,163,184,0.1)' : 'rgba(15,23,42,0.1)';

            if (winLossChart) winLossChart.destroy();
            winLossChart = new Chart(document.getElementById('winLossChart'), {
                type: 'doughnut',
                data: { labels: ['Win', 'Loss'], datasets: [{ data: [trades.filter(t => t.result === 'WIN').length, trades.filter(t => t.result === 'LOSS').length], backgroundColor: ['#10b981', '#ef4444'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, animation: false, cutout: '70%', plugins: { legend: { display: false } } }
            });

            if (assetChart) assetChart.destroy();
            const assetStats = {};
            trades.forEach(t => { if (!assetStats[t.asset]) assetStats[t.asset] = { w: 0, t: 0 }; assetStats[t.asset].t++; if (t.result === 'WIN') assetStats[t.asset].w++; });
            assetChart = new Chart(document.getElementById('assetChart'), {
                type: 'bar',
                data: { labels: Object.keys(assetStats).slice(0, 5), datasets: [{ data: Object.values(assetStats).slice(0, 5).map(s => ((s.w / s.t) * 100).toFixed(0)), backgroundColor: '#6366f1', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100, ticks: { display: false }, grid: { color: gridColor } }, x: { ticks: { color: textColor, font: { size: 8 } }, grid: { display: false } } } }
            });

            if (hourlyChart) hourlyChart.destroy();
            const hourStats = Array(24).fill(null).map(() => ({ w: 0, t: 0 }));
            trades.forEach(t => { const h = new Date(t.timestamp).getHours(); hourStats[h].t++; if (t.result === 'WIN') hourStats[h].w++; });
            hourlyChart = new Chart(document.getElementById('hourlyChart'), {
                type: 'line',
                data: { labels: Array.from({ length: 24 }, (_, i) => i), datasets: [{ data: hourStats.map(s => s.t ? ((s.w / s.t) * 100) : null), borderColor: '#6366f1', fill: false, tension: 0.4, pointRadius: 0, borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100, ticks: { display: false }, grid: { color: gridColor } }, x: { ticks: { color: textColor, font: { size: 8 }, maxTicksLimit: 6 }, grid: { display: false } } } }
            });

            if (expiryChart) expiryChart.destroy();
            const expStats = {};
            trades.forEach(t => { if (!expStats[t.expiry]) expStats[t.expiry] = { w: 0, t: 0 }; expStats[t.expiry].t++; if (t.result === 'WIN') expStats[t.expiry].w++; });
            expiryChart = new Chart(document.getElementById('expiryChart'), {
                type: 'bar',
                data: { labels: Object.keys(expStats), datasets: [{ data: Object.values(expStats).map(s => ((s.w / s.t) * 100).toFixed(0)), backgroundColor: '#8b5cf6', borderRadius: 4 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, max: 100, ticks: { display: false }, grid: { color: gridColor } }, y: { ticks: { color: textColor, font: { size: 8 } }, grid: { display: false } } } }
            });
        }

        // ==================== PSYCHOLOGY ====================
        function updatePsychology() {
            const textColor = currentTheme === 'dark' ? '#94a3b8' : '#64748b';
            const gridColor = currentTheme === 'dark' ? 'rgba(148,163,184,0.1)' : 'rgba(15,23,42,0.1)';
            const emojis = { 'Calm': 'üòå', 'Confident': 'üí™', 'Anxious': 'üò∞', 'FOMO': 'üò§' };

            const emotionStats = {};
            trades.forEach(t => { if (!emotionStats[t.emotionBefore]) emotionStats[t.emotionBefore] = { w: 0, t: 0 }; emotionStats[t.emotionBefore].t++; if (t.result === 'WIN') emotionStats[t.emotionBefore].w++; });

            document.getElementById('emotionHeatmap').innerHTML = Object.entries(emotionStats).sort((a, b) => (b[1].w / b[1].t) - (a[1].w / a[1].t)).map(([e, s]) => {
                const wr = ((s.w / s.t) * 100).toFixed(0);
                return `<div class="flex items-center justify-between p-2 rounded-lg bg-[var(--bg-tertiary)]"><span>${emojis[e] || 'üòê'} ${e}</span><span class="font-bold ${wr >= 60 ? 'text-green-400' : wr >= 50 ? 'text-yellow-400' : 'text-red-400'}">${wr}%</span></div>`;
            }).join('') || '<p class="text-xs text-center text-[var(--text-secondary)]">No data</p>';

            if (confidenceChart) confidenceChart.destroy();
            const confStats = Array(11).fill(null).map(() => ({ w: 0, t: 0 }));
            trades.forEach(t => { if (t.confidence >= 1 && t.confidence <= 10) { confStats[t.confidence].t++; if (t.result === 'WIN') confStats[t.confidence].w++; } });
            confidenceChart = new Chart(document.getElementById('confidenceChart'), {
                type: 'bar',
                data: { labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'], datasets: [{ data: confStats.slice(1).map(s => s.t ? ((s.w / s.t) * 100) : 0), backgroundColor: '#6366f1', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100, ticks: { display: false }, grid: { color: gridColor } }, x: { ticks: { color: textColor, font: { size: 9 } }, grid: { display: false } } } }
            });

            document.getElementById('revengeTrades').textContent = 0;
            document.getElementById('overtradingDays').textContent = 0;
            document.getElementById('tiltEpisodes').textContent = 0;
        }

        // ==================== GROWTH CALCULATOR ====================
        function calculateGrowth() {
            const startBal = parseFloat(document.getElementById('growthStartBalance')?.value || 100);
            const dailyGrowth = parseFloat(document.getElementById('growthDailyPercent')?.value || 5) / 100;
            const days = parseInt(document.getElementById('growthDays')?.value || 30);

            // Calculate compound growth with daily breakdown
            const balances = [startBal];
            const dailyProfits = [];
            let balance = startBal;
            let totalProfit = 0;
            
            for (let i = 1; i <= days; i++) {
                const startOfDay = balance;
                balance = balance * (1 + dailyGrowth);
                const dayProfit = balance - startOfDay;
                totalProfit += dayProfit;
                balances.push(parseFloat(balance.toFixed(2)));
                dailyProfits.push({
                    day: i,
                    start: startOfDay,
                    profit: dayProfit,
                    end: balance
                });
            }

            const finalBal = balance;
            const profit = finalBal - startBal;
            const growthPct = ((profit / startBal) * 100).toFixed(1);
            const dailyAvg = profit / days;

            // Update display
            document.getElementById('growthFinalBalance').textContent = '$' + finalBal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('growthTotalProfit').textContent = '+$' + profit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('growthPercentage').textContent = '+' + growthPct + '%';
            document.getElementById('growthDailyAvg').textContent = '+$' + dailyAvg.toFixed(2) + '/day';

            // Weekly breakdown
            const week1 = startBal * Math.pow(1 + dailyGrowth, Math.min(7, days));
            const week2 = startBal * Math.pow(1 + dailyGrowth, Math.min(14, days));
            const week4 = startBal * Math.pow(1 + dailyGrowth, Math.min(28, days));
            
            document.getElementById('growthWeek1').textContent = '$' + week1.toFixed(0);
            document.getElementById('growthWeek2').textContent = '$' + week2.toFixed(0);
            document.getElementById('growthWeek4').textContent = '$' + week4.toFixed(0);

            // Daily Profit Breakdown Table
            const tableBody = document.getElementById('dailyProfitTable');
            if (tableBody) {
                tableBody.innerHTML = dailyProfits.map(d => `
                    <tr class="hover:bg-[var(--bg-tertiary)]/50">
                        <td class="px-3 py-2 text-xs font-medium">Day ${d.day}</td>
                        <td class="px-3 py-2 text-xs text-right text-[var(--text-secondary)]">$${d.start.toFixed(2)}</td>
                        <td class="px-3 py-2 text-xs text-right font-semibold text-green-400">+$${d.profit.toFixed(2)}</td>
                        <td class="px-3 py-2 text-xs text-right font-medium">$${d.end.toFixed(2)}</td>
                    </tr>
                `).join('');
            }
            
            // Total profit sum
            const totalProfitSum = document.getElementById('growthTotalProfitSum');
            if (totalProfitSum) {
                totalProfitSum.textContent = '+$' + totalProfit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }

            // Chart
            if (growthChart) growthChart.destroy();
            growthChart = new Chart(document.getElementById('growthChart'), {
                type: 'line',
                data: { 
                    labels: balances.map((_, i) => i === 0 ? 'Start' : 'Day ' + i), 
                    datasets: [{ 
                        data: balances, 
                        borderColor: '#10b981', 
                        backgroundColor: 'rgba(16,185,129,0.1)', 
                        fill: true, 
                        tension: 0.4, 
                        pointRadius: 0, 
                        borderWidth: 2 
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    animation: false, 
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => '$' + ctx.raw.toLocaleString('en-US', {minimumFractionDigits: 2})
                            }
                        }
                    }, 
                    scales: { 
                        x: { display: false }, 
                        y: { 
                            ticks: { 
                                callback: v => '$' + v.toFixed(0),
                                color: currentTheme === 'dark' ? '#94a3b8' : '#64748b'
                            },
                            grid: {
                                color: currentTheme === 'dark' ? 'rgba(148,163,184,0.1)' : 'rgba(15,23,42,0.1)'
                            }
                        } 
                    } 
                }
            });
        }

        // ==================== FIREBASE & SOCIAL LOGIN ====================
        // Firebase Configuration - Replace with your own Firebase project credentials
        const firebaseConfig = {
            apiKey: "AIzaSyDemo-Key-Replace-With-Your-Own",
            authDomain: "tradeedge-pro.firebaseapp.com",
            projectId: "tradeedge-pro",
            storageBucket: "tradeedge-pro.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Initialize Firebase (wrapped in try-catch for demo mode)
        let firebaseApp = null;
        let firebaseAuth = null;
        
        try {
            if (typeof firebase !== 'undefined') {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                firebaseAuth = firebase.auth();
                console.log('Firebase initialized');
            }
        } catch (e) {
            console.log('Firebase demo mode - using simulated auth');
        }

        function handleGoogleLogin() {
            // Try real Firebase Google Auth first
            if (firebaseAuth) {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('profile');
                provider.addScope('email');
                
                firebaseAuth.signInWithPopup(provider)
                    .then((result) => {
                        const user = result.user;
                        currentUser = {
                            name: user.displayName || 'Google User',
                            email: user.email,
                            pic: user.photoURL,
                            provider: 'google',
                            uid: user.uid
                        };
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        showMainApp();
                        showToast('Logged in with Google!');
                    })
                    .catch((error) => {
                        console.log('Google auth error:', error.message);
                        // Fall back to demo mode
                        demoGoogleLogin();
                    });
            } else {
                // Demo mode
                demoGoogleLogin();
            }
        }

        function demoGoogleLogin() {
            // Show demo notice
            const demoNotice = confirm(
                'üîê Demo Mode\n\n' +
                'Real Google Sign-In requires Firebase setup.\n\n' +
                'To enable real authentication:\n' +
                '1. Create a Firebase project\n' +
                '2. Enable Google Sign-In\n' +
                '3. Add your config to the code\n\n' +
                'Click OK to continue with demo account.'
            );
            
            if (demoNotice) {
                const googleUser = {
                    name: 'Google User',
                    email: 'demo@gmail.com',
                    pic: 'https://ui-avatars.com/api/?name=Google+User&background=ea4335&color=fff&size=128',
                    provider: 'google'
                };
                
                currentUser = googleUser;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainApp();
                showToast('Logged in with Google (Demo)!');
            }
        }

        function handleGithubLogin() {
            // Try real Firebase GitHub Auth first
            if (firebaseAuth) {
                const provider = new firebase.auth.GithubAuthProvider();
                provider.addScope('user');
                
                firebaseAuth.signInWithPopup(provider)
                    .then((result) => {
                        const user = result.user;
                        currentUser = {
                            name: user.displayName || 'GitHub User',
                            email: user.email,
                            pic: user.photoURL,
                            provider: 'github',
                            uid: user.uid
                        };
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        showMainApp();
                        showToast('Logged in with GitHub!');
                    })
                    .catch((error) => {
                        console.log('GitHub auth error:', error.message);
                        // Fall back to demo mode
                        demoGithubLogin();
                    });
            } else {
                // Demo mode
                demoGithubLogin();
            }
        }

        function demoGithubLogin() {
            // Show demo notice
            const demoNotice = confirm(
                'üîê Demo Mode\n\n' +
                'Real GitHub Sign-In requires Firebase setup.\n\n' +
                'To enable real authentication:\n' +
                '1. Create a Firebase project\n' +
                '2. Enable GitHub Sign-In\n' +
                '3. Add your GitHub OAuth credentials\n' +
                '4. Add your config to the code\n\n' +
                'Click OK to continue with demo account.'
            );
            
            if (demoNotice) {
                const githubUser = {
                    name: 'GitHub User',
                    email: 'demo@github.com',
                    pic: 'https://ui-avatars.com/api/?name=GitHub+User&background=333&color=fff&size=128',
                    provider: 'github'
                };
                
                currentUser = githubUser;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainApp();
                showToast('Logged in with GitHub (Demo)!');
            }
        }

        function logout() {
            // Sign out from Firebase if available
            if (firebaseAuth) {
                firebaseAuth.signOut();
            }
            currentUser = null;
            localStorage.removeItem('currentUser');
            location.reload();
        }

        // ==================== RISK ENGINE ====================
        function calculatePosition() {
            const balance = parseFloat(document.getElementById('accountBalance')?.value || 1000);
            const risk = parseFloat(document.getElementById('riskPercent')?.value || 2);
            document.getElementById('calcResult').textContent = '$' + (balance * (risk / 100)).toFixed(2);
        }

        document.getElementById('maxRiskSlider')?.addEventListener('input', e => document.getElementById('maxRiskValue').textContent = e.target.value + '%');
        document.getElementById('maxTradesSlider')?.addEventListener('input', e => document.getElementById('maxTradesValue').textContent = e.target.value);
        document.getElementById('accountBalance')?.addEventListener('input', calculatePosition);
        document.getElementById('riskPercent')?.addEventListener('input', calculatePosition);

        // ==================== REPORTS ====================
        function updateReports() {
            if (!trades.length) {
                document.getElementById('reportsEmptyState').classList.remove('hidden');
                document.getElementById('reportsContent').classList.add('hidden');
                return;
            }
            document.getElementById('reportsEmptyState').classList.add('hidden');
            document.getElementById('reportsContent').classList.remove('hidden');

            const wins = trades.filter(t => t.result === 'WIN').length;
            const winRate = (wins / trades.length) * 100;
            const consistency = Math.min(100, winRate + 20);
            document.getElementById('reportConsistency').textContent = consistency.toFixed(0) + '%';
            document.getElementById('reportConsistencyBar').style.width = consistency + '%';

            const discipline = Math.min(100, 85);
            document.getElementById('reportDiscipline').textContent = discipline + '%';
            document.getElementById('reportDisciplineBar').style.width = discipline + '%';

            const calm = trades.filter(t => t.emotionBefore === 'Calm' || t.emotionBefore === 'Confident').length;
            const behavioral = Math.min(100, (calm / trades.length) * 100 + 20);
            document.getElementById('reportBehavioral').textContent = behavioral.toFixed(0) + '%';
            document.getElementById('reportBehavioralBar').style.width = behavioral + '%';

            const badges = [
                { icon: 'üî•', name: '5 Streak', unlocked: false },
                { icon: 'üìà', name: 'Profitable', unlocked: trades.reduce((s, t) => s + t.pl, 0) > 0 },
                { icon: 'üéØ', name: '70% WR', unlocked: winRate >= 70 },
                { icon: 'üßò', name: 'No Tilt', unlocked: false },
                { icon: 'üíé', name: '10 Streak', unlocked: false },
                { icon: 'üëë', name: 'Perfect', unlocked: false }
            ];
            document.getElementById('achievementsBadges').innerHTML = badges.map(b => `
                <div class="text-center p-3 rounded-lg ${b.unlocked ? 'bg-yellow-500/20 border border-yellow-500/30' : 'bg-gray-500/20 opacity-50'}">
                    <div class="text-2xl mb-1">${b.icon}</div>
                    <p class="text-xs">${b.name}</p>
                </div>
            `).join('');
        }

        // ==================== SETTINGS ====================
        function loadSettings() {
            const sb = localStorage.getItem('startingBalance');
            if (sb && document.getElementById('startingBalanceInput')) document.getElementById('startingBalanceInput').value = sb;
        }

        function saveStartingBalance(val) {
            localStorage.setItem('startingBalance', val);
            updateDashboard();
            updateEquityChart();
            showToast('Starting balance saved!');
        }

        // ==================== DATA ====================
        function saveTrades() { localStorage.setItem('trades', JSON.stringify(trades)); }

        function exportData(format) {
            const startDate = document.getElementById('exportStartDate')?.value;
            const endDate = document.getElementById('exportEndDate')?.value;
            
            let filteredTrades = trades;
            if (startDate && endDate) {
                filteredTrades = trades.filter(t => {
                    const d = new Date(t.timestamp);
                    return d >= new Date(startDate) && d <= new Date(endDate + 'T23:59:59');
                });
            }

            if (format === 'pdf') {
                generateProfessionalPDF(filteredTrades, startDate, endDate);
            } else if (format === 'csv') {
                const csv = 'Date,Asset,Direction,Result,P/L,Strategy\n' + filteredTrades.map(t => `${new Date(t.timestamp).toLocaleDateString()},${t.asset},${t.direction},${t.result},${t.pl},${t.strategy}`).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'trades.csv'; a.click();
            } else {
                const blob = new Blob([JSON.stringify(filteredTrades, null, 2)], { type: 'application/json' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'trades.json'; a.click();
            }
            showToast(`Exported ${filteredTrades.length} trades!`);
            document.getElementById('exportDropdown').classList.remove('show');
        }

        function generateProfessionalPDF(filteredTrades, startDate, endDate) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Colors
            const primaryColor = [99, 102, 241]; // Indigo
            const successColor = [16, 185, 129]; // Green
            const dangerColor = [239, 68, 68]; // Red
            const darkBg = [15, 23, 42];
            const grayText = [148, 163, 184];
            
            // Calculate stats
            const totalTrades = filteredTrades.length;
            const wins = filteredTrades.filter(t => t.result === 'WIN').length;
            const losses = filteredTrades.filter(t => t.result === 'LOSS').length;
            const ties = filteredTrades.filter(t => t.result === 'TIE').length;
            const winRate = totalTrades ? ((wins / totalTrades) * 100).toFixed(1) : 0;
            const totalPL = filteredTrades.reduce((s, t) => s + t.pl, 0);
            const totalStake = filteredTrades.reduce((s, t) => s + t.stake, 0);
            const avgWin = wins ? filteredTrades.filter(t => t.result === 'WIN').reduce((s, t) => s + t.pl, 0) / wins : 0;
            const avgLoss = losses ? Math.abs(filteredTrades.filter(t => t.result === 'LOSS').reduce((s, t) => s + t.pl, 0)) / losses : 0;
            const profitFactor = avgLoss ? (avgWin * wins) / (avgLoss * losses) : 0;
            const startingBalance = parseFloat(localStorage.getItem('startingBalance')) || 1000;
            const currentBalance = startingBalance + trades.reduce((s, t) => s + t.pl, 0);
            
            // Date range text
            const dateRangeText = startDate && endDate 
                ? `${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}`
                : 'All Time';
            
            // Page 1: Header & Summary
            // Header background
            doc.setFillColor(...darkBg);
            doc.rect(0, 0, 210, 45, 'F');
            
            // Logo placeholder (circle)
            doc.setFillColor(...primaryColor);
            doc.circle(25, 22, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('TE', 22, 25);
            
            // Title
            doc.setFontSize(24);
            doc.setTextColor(255, 255, 255);
            doc.text('TradeEdge Pro', 45, 20);
            
            // Subtitle
            doc.setFontSize(10);
            doc.setTextColor(...grayText);
            doc.text('Professional Trading Performance Report', 45, 28);
            
            // Date & Generated info
            doc.setFontSize(8);
            doc.text(`Report Period: ${dateRangeText}`, 45, 36);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 130, 36);
            
            // Account Summary Section
            let yPos = 55;
            doc.setFillColor(30, 41, 59);
            doc.roundedRect(10, yPos, 190, 45, 3, 3, 'F');
            
            doc.setTextColor(...primaryColor);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('ACCOUNT SUMMARY', 15, yPos + 10);
            
            // Summary boxes
            const boxWidth = 42;
            const boxStartX = 15;
            const boxY = yPos + 18;
            
            // Balance box
            doc.setFillColor(51, 65, 85);
            doc.roundedRect(boxStartX, boxY, boxWidth, 20, 2, 2, 'F');
            doc.setTextColor(...grayText);
            doc.setFontSize(8);
            doc.text('Current Balance', boxStartX + 5, boxY + 8);
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('$' + currentBalance.toLocaleString('en-US', {minimumFractionDigits: 2}), boxStartX + 5, boxY + 16);
            
            // Total P/L box
            doc.setFillColor(51, 65, 85);
            doc.roundedRect(boxStartX + boxWidth + 5, boxY, boxWidth, 20, 2, 2, 'F');
            doc.setTextColor(...grayText);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text('Total P/L', boxStartX + boxWidth + 10, boxY + 8);
            doc.setTextColor(totalPL >= 0 ? successColor[0] : dangerColor[0], totalPL >= 0 ? successColor[1] : dangerColor[1], totalPL >= 0 ? successColor[2] : dangerColor[2]);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text((totalPL >= 0 ? '+$' : '-$') + Math.abs(totalPL).toFixed(2), boxStartX + boxWidth + 10, boxY + 16);
            
            // Win Rate box
            doc.setFillColor(51, 65, 85);
            doc.roundedRect(boxStartX + (boxWidth + 5) * 2, boxY, boxWidth, 20, 2, 2, 'F');
            doc.setTextColor(...grayText);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text('Win Rate', boxStartX + (boxWidth + 5) * 2 + 5, boxY + 8);
            doc.setTextColor(parseFloat(winRate) >= 55 ? successColor[0] : dangerColor[0], parseFloat(winRate) >= 55 ? successColor[1] : dangerColor[1], parseFloat(winRate) >= 55 ? successColor[2] : dangerColor[2]);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(winRate + '%', boxStartX + (boxWidth + 5) * 2 + 5, boxY + 16);
            
            // Profit Factor box
            doc.setFillColor(51, 65, 85);
            doc.roundedRect(boxStartX + (boxWidth + 5) * 3, boxY, boxWidth, 20, 2, 2, 'F');
            doc.setTextColor(...grayText);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text('Profit Factor', boxStartX + (boxWidth + 5) * 3 + 5, boxY + 8);
            doc.setTextColor(profitFactor >= 1.5 ? successColor[0] : profitFactor >= 1 ? 245 : dangerColor[0], profitFactor >= 1.5 ? successColor[1] : profitFactor >= 1 ? 158 : dangerColor[1], profitFactor >= 1.5 ? successColor[2] : profitFactor >= 1 ? 11 : dangerColor[2]);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(profitFactor.toFixed(2), boxStartX + (boxWidth + 5) * 3 + 5, boxY + 16);
            
            // Performance Statistics Section
            yPos = 110;
            doc.setTextColor(...primaryColor);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('PERFORMANCE STATISTICS', 15, yPos);
            
            yPos += 8;
            doc.setFillColor(30, 41, 59);
            doc.roundedRect(10, yPos, 92, 60, 3, 3, 'F');
            doc.roundedRect(108, yPos, 92, 60, 3, 3, 'F');
            
            // Left column stats
            doc.setFontSize(9);
            const leftStats = [
                ['Total Trades', totalTrades.toString()],
                ['Winning Trades', wins.toString()],
                ['Losing Trades', losses.toString()],
                ['Tie Trades', ties.toString()],
                ['Average Win', '+$' + avgWin.toFixed(2)],
                ['Average Loss', '-$' + avgLoss.toFixed(2)]
            ];
            
            leftStats.forEach((stat, i) => {
                doc.setTextColor(...grayText);
                doc.setFont('helvetica', 'normal');
                doc.text(stat[0], 15, yPos + 10 + (i * 9));
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.text(stat[1], 85, yPos + 10 + (i * 9), { align: 'right' });
            });
            
            // Right column stats
            const rightStats = [
                ['Total Stake', '$' + totalStake.toFixed(2)],
                ['ROI', ((totalPL / totalStake) * 100).toFixed(1) + '%'],
                ['Best Trade', '+$' + (filteredTrades.length ? Math.max(...filteredTrades.map(t => t.pl)).toFixed(2) : '0.00')],
                ['Worst Trade', '-$' + (filteredTrades.length ? Math.abs(Math.min(...filteredTrades.map(t => t.pl))).toFixed(2) : '0.00')],
                ['Avg Trade P/L', '$' + (totalTrades ? (totalPL / totalTrades).toFixed(2) : '0.00')],
                ['Expectancy', '$' + (totalTrades ? ((winRate/100 * avgWin) - ((100-winRate)/100 * avgLoss)).toFixed(2) : '0.00')]
            ];
            
            rightStats.forEach((stat, i) => {
                doc.setTextColor(...grayText);
                doc.setFont('helvetica', 'normal');
                doc.text(stat[0], 113, yPos + 10 + (i * 9));
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.text(stat[1], 185, yPos + 10 + (i * 9), { align: 'right' });
            });
            
            // Trade History Table
            yPos = 185;
            doc.setTextColor(...primaryColor);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('TRADE HISTORY', 15, yPos);
            
            if (filteredTrades.length > 0) {
                const tableData = filteredTrades.slice(0, 15).map(t => [
                    new Date(t.timestamp).toLocaleDateString(),
                    t.asset,
                    t.direction,
                    t.expiry,
                    '$' + t.stake.toFixed(2),
                    t.result,
                    (t.pl >= 0 ? '+' : '') + '$' + t.pl.toFixed(2)
                ]);
                
                doc.autoTable({
                    startY: yPos + 5,
                    head: [['Date', 'Asset', 'Dir', 'Expiry', 'Stake', 'Result', 'P/L']],
                    body: tableData,
                    theme: 'plain',
                    headStyles: {
                        fillColor: [51, 65, 85],
                        textColor: [148, 163, 184],
                        fontSize: 8,
                        fontStyle: 'bold',
                        cellPadding: 3
                    },
                    bodyStyles: {
                        fillColor: [30, 41, 59],
                        textColor: [255, 255, 255],
                        fontSize: 8,
                        cellPadding: 3
                    },
                    alternateRowStyles: {
                        fillColor: [51, 65, 85]
                    },
                    columnStyles: {
                        5: { cellWidth: 18 },
                        6: { cellWidth: 22 }
                    },
                    didParseCell: function(data) {
                        if (data.column.index === 5 && data.section === 'body') {
                            if (data.cell.raw === 'WIN') {
                                data.cell.styles.textColor = successColor;
                            } else if (data.cell.raw === 'LOSS') {
                                data.cell.styles.textColor = dangerColor;
                            }
                        }
                        if (data.column.index === 6 && data.section === 'body') {
                            const val = data.cell.raw;
                            if (val.startsWith('+')) {
                                data.cell.styles.textColor = successColor;
                            } else if (val.startsWith('-')) {
                                data.cell.styles.textColor = dangerColor;
                            }
                        }
                        if (data.column.index === 2 && data.section === 'body') {
                            if (data.cell.raw === 'CALL') {
                                data.cell.styles.textColor = successColor;
                            } else if (data.cell.raw === 'PUT') {
                                data.cell.styles.textColor = dangerColor;
                            }
                        }
                    }
                });
                
                if (filteredTrades.length > 15) {
                    doc.setTextColor(...grayText);
                    doc.setFontSize(8);
                    doc.text(`Showing 15 of ${filteredTrades.length} trades. Export CSV for complete data.`, 15, doc.lastAutoTable.finalY + 8);
                }
            } else {
                doc.setTextColor(...grayText);
                doc.setFontSize(10);
                doc.text('No trades in selected period.', 15, yPos + 15);
            }
            
            // Footer
            const pageHeight = doc.internal.pageSize.height;
            doc.setFillColor(...darkBg);
            doc.rect(0, pageHeight - 20, 210, 20, 'F');
            
            doc.setTextColor(...grayText);
            doc.setFontSize(8);
            doc.text('Generated by TradeEdge Pro | Created by Sayan Roy', 15, pageHeight - 8);
            doc.text('Page 1', 190, pageHeight - 8, { align: 'right' });
            
            // Save the PDF
            const filename = startDate && endDate 
                ? `TradeEdge_Report_${startDate}_to_${endDate}.pdf`
                : `TradeEdge_Report_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    trades = [...imported, ...trades];
                    saveTrades();
                    updateDashboard();
                    populateRecentTrades();
                    populateTradeHistory();
                    updateEquityChart();
                    showToast('Data imported!');
                } catch (err) { showToast('Import error', 'error'); }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('Delete ALL data?')) {
                trades = [];
                localStorage.removeItem('trades');
                updateDashboard();
                populateRecentTrades();
                populateTradeHistory();
                updateEquityChart();
                showToast('Data cleared');
            }
        }

        // ==================== UTILS ====================
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = msg;
            document.querySelector('#toastContent i').className = type === 'success' ? 'fas fa-check-circle text-green-400' : 'fas fa-exclamation-circle text-red-400';
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function initEventListeners() {
            document.getElementById('searchTrades')?.addEventListener('input', filterTrades);
            document.getElementById('filterResult')?.addEventListener('change', filterTrades);
        }

        function filterTrades() {
            const search = document.getElementById('searchTrades').value.toLowerCase();
            const result = document.getElementById('filterResult').value;
            const filtered = trades.filter(t => {
                if (search && !t.asset.toLowerCase().includes(search)) return false;
                if (result && t.result !== result) return false;
                return true;
            });
            document.getElementById('tradeHistoryTable').innerHTML = filtered.map(t => `
                <tr class="hover:bg-[var(--bg-tertiary)]/50">
                    <td class="px-4 py-3 text-xs">${new Date(t.timestamp).toLocaleDateString()}</td>
                    <td class="px-4 py-3 text-xs font-medium">${t.asset}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs ${t.direction === 'CALL' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">${t.direction}</span></td>
                    <td class="px-4 py-3 text-xs">$${t.stake.toFixed(2)}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs font-bold ${t.result === 'WIN' ? 'win-badge' : 'loss-badge'}">${t.result}</span></td>
                    <td class="px-4 py-3 text-xs font-medium ${t.pl >= 0 ? 'text-green-400' : 'text-red-400'}">${t.pl >= 0 ? '+' : ''}$${t.pl.toFixed(2)}</td>
                    <td class="px-4 py-3"><button onclick="deleteTrade(${t.id})" class="text-red-400"><i class="fas fa-trash text-xs"></i></button></td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>
